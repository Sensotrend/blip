function CustomTooltip(d,b){var d=d;$("body").append("<div class='tooltip' id='"+d+"'></div>");if(b){$("#"+d).css("width",b)}a();function e(g,f){log("custom");log($("#"+d));$("#"+d).html(g);$("#"+d).show();c(f)}function a(){$("#"+d).hide()}function c(g){var h="#"+d;var p=20;var l=10;var t=$(h).width();var n=$(h).height();var q=$(window).scrollTop();var r=$(window).scrollLeft();var i=(document.all)?g.clientX+r:g.pageX;var f=(document.all)?g.clientY+q:g.pageY;var u=((i-r+p*2+t)>$(window).width())?i-t-p*2:i+p;if(u<r+p){u=r+p}var o=((f-q+l*2+n)>$(window).height())?f-n-l*2:f+l;if(o<q+l){o=f+l}$(h).css("top",o+"px").css("left",u+"px")}return{showTooltip:e,hideTooltip:a,updatePosition:c}}function moveto(a,b){return"M"+a+" "+b}function lineto(a,b){return"L"+a+" "+b}function curveto(b,e,a,d){var c=a+" "+d;return"C"+c+" "+c+" "+b+" "+e}function cartoon_bubble_path(a,i,c,e,f,b,d){var g=moveto(a,i+f);g+=lineto(a,i+e-f);g+=curveto(a+f,i+e,a,i+e);g+=lineto(a+c/2-b,i+e);g+=lineto(a+c/2,i+e+d);g+=lineto(a+c/2+b,i+e);g+=lineto(a+c-f,i+e);g+=curveto(a+c,i+e-f,a+c,i+e);g+=lineto(a+c,i+f);g+=curveto(a+c-f,i,a+c,i);g+=lineto(a+f,i);g+=curveto(a,i+f,a,i);return g}if(0){cartoon_bubble_path(3,3,10,5,4,2,2)}function hsvToRgb(l,y,w){var a,n,u;var e=Math.floor(l*6);var o=l*6-e;var d=w*(1-y);var c=w*(1-o*y);var x=w*(1-(1-o)*y);switch(e%6){case 0:a=w,n=x,u=d;break;case 1:a=c,n=w,u=d;break;case 2:a=d,n=w,u=x;break;case 3:a=d,n=c,u=w;break;case 4:a=x,n=d,u=w;break;case 5:a=w,n=d,u=c;break}return[a*255,n*255,u*255]}function bg_to_simple_color(e){var d,c,a;if(e<80){return"blue"}if(e<140){return"#24c72c";return"#3ca845"}if(e<180){return"yellow";return"#f2ee6b"}return"red"}function bg_to_simple_color2(e){var d,c,a;if(e<80){return"blue"}if(e<140){return"#24c72c";return"#3ca845"}if(e<180){return"yellow";return"#f2ee6b"}if(e>=350){return d3.rgb(255,0,255)}return"red"}function bg_to_color(g){var f,e,a;if(g<80){var c=(g-40)/(80-40);if(c<0){c=0}var d=d3.scale.pow().exponent(2).range([240/360,120/360]);f=d(c);e=1-c*0.3;a=0.9}else{if(g<250){var c=(g-80)/(250-80);if(c<0){c=0}var d=d3.scale.pow().exponent(0.5).range([120/360,0/360]);f=d(c);e=0.7;a=0.9}else{if(g>=300){return d3.rgb(255,0,255)}var c=(g-250)/(300-250);if(c<0){c=0}f=0;e=0.7+c*0.28;a=0.9+c*0.1}}rgb=hsvToRgb(f,e,a);return d3.rgb(rgb[0],rgb[1],rgb[2])}function make_bg_to_color3(){var b=d3.scale.linear().interpolate(d3.interpolateRgb).domain([80,140]).range([bg_to_color(80),bg_to_color(95)]);var c=d3.scale.linear().interpolate(d3.interpolateRgb).domain([140,180]).range([bg_to_color(100),bg_to_color(230)]);var d=d3.scale.linear().interpolate(d3.interpolateRgb).domain([180,250]).range([bg_to_color(230),bg_to_color(290)]);var a=d3.scale.linear().interpolate(d3.interpolateRgb).domain([250,305]).range([bg_to_color(290),bg_to_color(310)]);return function(e){if(e<80){return bg_to_color(e)}if(e<140){return b(e)}if(e<180){return c(e)}if(e<250){return d(e)}return a(e)}}var ramp4=d3.scale.linear().interpolate(d3.interpolateHsl).domain([0,65,80,130,145,170,190,275,310,1000]).range([bg_to_color(50),bg_to_color(50),bg_to_color(80),bg_to_color(80),bg_to_color(120),bg_to_color(120),bg_to_color(280),bg_to_color(280),bg_to_color(310),bg_to_color(310)]);function map_hue(b){var f=d3.hsl(b);var a=f.h;var e=0.6;var d=0.8;return d3.hsl(a,d,e)}var ramp5=d3.scale.linear().interpolate(d3.interpolateHsl).domain([0,65,80,130,145,170,190,275,310,1000]).range([map_hue(bg_to_color(50)),map_hue(bg_to_color(50)),map_hue(bg_to_color(80)),map_hue(bg_to_color(80)),map_hue(bg_to_color(120)),map_hue(bg_to_color(120)),map_hue(bg_to_color(280)),map_hue(bg_to_color(280)),map_hue(bg_to_color(310)),map_hue(bg_to_color(310))]);var ramp6=d3.scale.linear().interpolate(d3.interpolateHsl).domain([0,60,60,70,70,140,140,180,180,300,300,1000]).range([bg_to_color(50),bg_to_color(50),bg_to_color(65),bg_to_color(65),bg_to_color(80),bg_to_color(80),bg_to_color(120),bg_to_color(120),bg_to_color(280),bg_to_color(280),bg_to_color(310),bg_to_color(310)]);var ramp7=d3.scale.linear().interpolate(d3.interpolateHsl).domain([0,60,60,70,70,140,140,180,180,300,300,1000]).range([bg_to_color(50),bg_to_color(50),bg_to_color(65),bg_to_color(65),bg_to_simple_color(80),bg_to_simple_color(80),bg_to_simple_color(150),bg_to_simple_color(150),bg_to_simple_color(280),bg_to_simple_color(280),bg_to_color(310),bg_to_color(310)]);var ramp8=d3.scale.linear().interpolate(d3.interpolateHsl).domain([0,60,60,75,75,140,140,180,180,300,300,1000]).range([bg_to_color(50),bg_to_color(50),bg_to_color(65),bg_to_color(65),bg_to_simple_color(80),bg_to_simple_color(80),bg_to_simple_color(150),bg_to_simple_color(150),bg_to_simple_color(280),bg_to_simple_color(280),bg_to_color(310),bg_to_color(310)]);var ramp9=d3.scale.linear().interpolate(d3.interpolateHsl).domain([0,60,60,75,75,140,140,180,180,300,300,1000]).range([bg_to_color(50),bg_to_color(50),bg_to_color(65),bg_to_color(65),bg_to_simple_color(80),bg_to_simple_color(80),bg_to_simple_color(150),bg_to_simple_color(150),bg_to_color(310),bg_to_color(310),bg_to_simple_color(280),bg_to_simple_color(280)]);var ramp10=d3.scale.linear().interpolate(d3.interpolateHsl).domain([0,60,60,75,75,140,140,180,180,300,300,1000]).range([bg_to_color(50),bg_to_color(60),bg_to_color(60),bg_to_color(75),bg_to_simple_color(80),bg_to_simple_color(80),bg_to_simple_color(150),bg_to_simple_color(150),"orange","orangered",bg_to_simple_color(280),bg_to_simple_color(280)]);var ramps=[bg_to_simple_color,bg_to_color,make_bg_to_color3(),ramp4,ramp5,ramp6,ramp7,ramp8,ramp9];var bg_color_ramp=ramp10;function set_color_ramp(a){if(a<0){a=0}else{if(a>=ramps.length){a=ramps.length-1}}bg_color_ramp=ramps[a]}function bg_color(a){return bg_color_ramp(a.y)}dbd={};dbd.show_popup_date=false;var daylight=[0,1,2,3,4,5,9,14,16,17,18,20,22,20,18,17,16,14,9,5,4,3,2,1];dbd.hour_to_color=function(c){var a=150;var b=20;if(true){c=Math.floor(c/3)*3;b=40;a=90}var d=daylight[Math.floor(c)]/24;var e=Math.floor(d*(a-b))+b;return d3.rgb(e,e,e)};dbd.new_hour_to_color=function(c){var d=[0,0.1,0.1,0.1,0.1,0.2,0.4,0.6,0.7,0.9,0.95,1,1,1,1,0.95,0.9,0.7,0.6,0.4,0.2,0.1,0.1,0.1,0.1];var a=190;var b=50;d=daylight[Math.floor(c)]/24;var e=Math.floor(d*(a-b))+b;return d3.rgb(e,e,e)};function click_show_numbers(){var a=$("#checkbox_show_numbers");a.click()}dbd.draw_ramp=function(){var a=this.vis;var c=this.scale.detail.x;var o=this.hour_to_color;var d=midnight(this.sdate);var b=d3.time.hour.offset(d,1);var n=c(b)-c(d);var g=this.vh;var i=24*(this.ndays+1);for(hour=0;hour<i;++hour){var e=this.hour_to_color(hour%24);var l=a.append("rect").attr("class","shade").attr("x",c(d3.time.hour.offset(d,hour))).attr("y",0).attr("width",n).attr("height",g).attr("stroke",e).attr("fill",e);var f=d3.behavior.drag();if(true){f.on("dragstart",function(p,h){dbd.drag_origin=undefined;click_show_numbers()});f.on("dragend",function(p,h){click_show_numbers()});f.on("drag",function(r,p){if(dbd.mode!="detailed"){return}var q=d3.event.x;if(dbd.drag_origin==undefined){dbd.drag_origin=q;return}var h=q-dbd.drag_origin;dbd.shift_viewer_pixels(h,false)})}l.call(f)}};dbd.draw_time_legend=function(){var c=24*this.ndays;var d=this.time_legend;var b;var a=midnight(this.sdate);var f=this.scale.detail.x;for(b=0;b<c;b+=3){var g=d3.time.hour.offset(a,b);var e=d.append("text");e.attr("x",f(g)).attr("y",26-10-5).attr("font-size","90%").attr("text-anchor","middle").text(hour_to_string2(b))}return;for(b=12;b<c;b+=24){var g=d3.time.hour.offset(a,b);d.append("text").attr("class","sp-detailed").attr("x",this.xscale_day(g)).attr("y",10).attr("font-size","90%").attr("text-anchor","middle").text(weekday(g)+" "+friendly_date3(g))}};dbd.set_pan=function(a,b){a+=this.pad;if(b){d3.select("#pan-window").transition().duration(250).attr("transform",fmt_translate(a,0));d3.select("#time-panner").transition().duration(250).attr("transform",fmt_translate(a,0))}else{d3.select("#pan-window").attr("transform",fmt_translate(a,0));d3.select("#time-panner").attr("transform",fmt_translate(a,0))}};function dbd_dragmove(c,b){if(dbd.mode!="detailed"){return}var a=d3.event.dx;dbd.shift_viewer_pixels(a,false)}dbd.shift_viewer_pixels=function(a,c){var b=(a/this.vw)*24*60;this.shift_viewer_by_minutes(-b,c)};dbd.shift_viewer_by_minutes=function(d,e){var c=d3.time.minute.offset(this.viewer_date,d);var a=d3.time.minute.offset(this.sdate,-0*(24*60));var b=d3.time.minute.offset(this.edate,0.5*(24*60));if(c<a){c=a}if(c>b){c=b}this.position_viewer_at(c,e)};dbd.relative_position=function(b){var d=this.edate.getTime();var c=this.sdate.getTime();var a=b.getTime();return((a-c)/(d-c))};dbd.relative_date=function(e){var d=this.edate.getTime();var c=this.sdate.getTime();var b=c+e*(d-c);var a=new Date;a.setTime(b);return a};function clear_popup_date(){d3.select("#throw-date").remove();dbd.popup_date_svg=undefined;dbd.popup_date=undefined;dbd.popup_timer=undefined}dbd.draw_popup_date=function(b){var a=midnight(b);if(this.popup_date==undefined){this.popup_date_svg=this.inner.append("text").attr("id","throw-date").attr("x",this.inner_w/2).attr("y",this.inner_h/2).attr("text-anchor","middle").attr("font-size","400%").attr("fill","white").attr("opacity","0.1").text(friendly_date2(b));this.popup_date=a;dbd.popup_timer=setTimeout(clear_popup_date,1200)}else{if(this.popup_date.getTime()!=a.getTime()){this.popup_date_svg.text(friendly_date2(b));this.popup_date=a}clearTimeout(dbd.popup_timer);dbd.popup_timer=setTimeout(clear_popup_date,1200)}};dbd.position_viewer_at=function(b,d){if(dbd.show_popup_date){this.draw_popup_date(b)}this.viewer_date=b;b=d3.time.minute.offset(b,-12*60);var a=this.scale.detail.x(b);this.set_pan(-a,d);var c=this.relative_position(b);slider_set(c)};dbd.position_viewer_from_slider=function(c){var b=this.relative_date(c);this.viewer_date=b;if(dbd.show_popup_date){this.draw_popup_date(b)}b=d3.time.minute.offset(b,-12*60);var a=this.scale.detail.x(b);this.set_pan(-a,false)};dbd.set_date=function(c){c=midnight(c);var b=$("#db-edate");b.attr("value",c);b.attr("text",friendly_date3(c));var a=d3.time.day.offset(c,-14);dashboard_clear();draw_dashboard(a,c)};function dbd_keydown(n,g){var h=d3.event.keyCode;if(h>=49&&h<=(49+7)){var f=h-49;set_color_ramp(f);dashboard_clear();draw_dashboard(dbd.sdate,dbd.edate);return}if(d3.event.metaKey&&d3.event.keyCode==69){dbd.eMode=!dbd.eMode;dashboard_clear();draw_dashboard(dbd.sdate,dbd.edate);return}if(h==32&&false){var e=$("#checkbox_show_numbers");e.click();return}if(dbd.mode=="daily"||dbd.mode=="hourly"){var l;var b=d3.event.keyIdentifier;if(b=="Right"){date_right()}if(b=="Left"){date_left()}return}if(dbd.mode!="detailed"){return}var b=d3.event.keyIdentifier;var p=0.5;if(d3.event.shiftKey){p=3}if(d3.event.ctrlKey){p=12}var a=new Date().getTime();if(dbd.last_keypress_time!=undefined){var c=a-dbd.last_keypress_time;if(c<500){dbd.continuous_clicks+=1}else{dbd.continuous_clicks=1}}else{dbd.continuous_clicks=1}dbd.last_keypress_time=a;var o=Math.round((dbd.continuous_clicks/2)-0.5)*2;p*=(o+1);if(b!=undefined){if(b=="Right"){dbd.shift_viewer_by_minutes(p*60,true)}if(b=="Left"){dbd.shift_viewer_by_minutes(-p*60,true)}}}dbd.click_to_detailed=function(a){$("#detailed_tab a").click();dbd.position_viewer_at(a,false)};dbd.eMode=false;dbd.mode="daily";dbd.show_numbers=false;dbd.init=function(p,E,c,f,A){this.container=p;if(this.ctip==undefined){this.ctip=CustomTooltip("message_tooltip",240)}else{this.ctip.hideTooltip()}var y=20;var i=60;var o=17;var t=4;var F=this.pad=20;var q=this.vw=f-i-2*F;var I=this.vh=A-y-(o+t);this.color_mode="simple";this.outer=p.append("svg").attr("width",f).attr("height",A);this.time_legend=this.outer.append("svg").attr("id","time-legend").attr("x",i).attr("y",0).attr("width",q+2*F).attr("height",y).append("g").attr("id","time-panner").attr("transform",fmt_translate(F,0));this.y_legend=this.outer.append("svg").attr("x",0).attr("y",y).attr("width",i).attr("height",I).append("g").attr("transform",fmt_translate(0,0));this.y_legend_width=i;this.inner_w=q+2*F;this.inner_h=I;this.inner=this.outer.append("svg").attr("x",i).attr("y",y).attr("width",this.inner_w).attr("height",this.inner_h).attr("id","dashboard-inner");var B=q+2*F;this.slider=this.outer.append("svg").attr("x",i).attr("y",y+I+4).attr("width",B).attr("height",o).attr("class","sp-detailed").attr("visibility","hidden");make_slider(this.slider,0,0,B,o,1/24);var r=this.hour_to_color(0);this.inner.append("rect").attr("x",0).attr("y",0).attr("width",q+2*F).attr("height",I).attr("fill",r);this.vis=this.inner.append("g").attr("id","pan-window").attr("transform",fmt_translate(0,0));this.sdate=E;this.edate=c;this.viewer_date=noon(c);var D=d3.time.day.offset(this.edate,1);this.dateRange=d3.time.days(this.sdate,D);var e=midnight(E);var d=midnight(D);var G=d3.scale.linear().domain([0,24]).range([0,q]);var C=function(h){return G(get_hour(h))};this.ndays=this.dateRange.length;var n=d3.scale.linear().domain([e,d]).range([0,q*this.ndays]);var g=d3.scale.linear().domain([40,360]).range([I,0]);var l=function(h){return g(limit(h.y,40,350))};var H=I/this.ndays;var b=H/2;this.yscale_day=d3.scale.linear().domain([e,d]).range([I,0]);var a=function(h){return dbd.yscale_day(noon(h.x))};var u=function(M){var K=limit(M.y,40,350);var h=(K-40)/(350-40);h=h-0.5;var N=noon(M.x);var w=dbd.yscale_day(N);var J=dbd.yscale_day(add_days(N,-1));var L=J-w;return w-L*h};this.r1=0.4*I;this.r2=0.7*I;this.r3=0.75*I;this.r4=0.8*I;this.r5=I;var x=d3.scale.linear().domain([40,360]).range([this.r1,0]);this.scale={day:{x:C,bg:a,cgm:u},hour:{x:C,bg:l},detail:{x:n,bg:function(h){return x(limit(h.y,40,350))},carbs:d3.scale.linear().domain([0,200]).range([this.r1,this.r2]),bolus:d3.scale.linear().domain([0,9]).range([this.r2,this.r1]),basal:d3.scale.linear().domain([0.4,1.4]).range([this.r5,this.r4]),events:function(h){return(dbd.r2+dbd.r3)/2},messages:function(h){return(dbd.r1+dbd.r2)/2},insmix:function(h){return(dbd.r2+dbd.r3)/2}},stacked:[this.build_vscale(0,I/4,C,100,10),this.build_vscale(I/4,2*I/4,C,100,10),this.build_vscale(2*I/4,3*I/4,C,100,10)]};this.draw_ramp();this.draw_day_grid(-20,this.ndays*q);this.draw_bg_grid(-20,this.ndays*q);this.draw_vbg_grid(-20,this.ndays*q);this.draw_bolus_grid(-20,this.ndays*q);this.draw_stacked_grid(-20,this.ndays*q);this.draw_time_legend();this.draw_day_legend();this.draw_bg_legend();this.draw_detail_legend();var z=d3.behavior.drag().on("drag",dbd_dragmove);this.time_legend.call(z);d3.select(window).on("keydown",dbd_keydown);this.vis.on("mousedown",function(w,h){if(tooltip.item!=undefined){tooltip.lock()}}).on("mouseup",function(w,h){tooltip.break_lock()}).on("mousemove",function(w,h){tooltip.travel()})};dbd.set_numbers_disposition=function(){var b=6;var a=d3.select("#bg-g");if($("#checkbox_show_numbers").prop("checked")){if(dbd.mode=="stacked"){this.show_stacked_bgnums()}else{d3.selectAll(".BG-text").attr("visibility","visible")}if(dbd.mode=="daily"){a.attr("transform",fmt_translate(0,b))}else{a.attr("transform",null)}if(!$("#checkbox_show_entra").prop("checked")){d3.selectAll(".BG-text-entra").attr("visibility","hidden")}}else{d3.selectAll(".BG-text").attr("visibility","hidden");a.attr("transform",null)}};dbd.set_entra_disposition=function(){d3.select(".entra");if($("#checkbox_show_entra").prop("checked")){d3.selectAll(".entra").attr("visibility","visible")}else{d3.selectAll(".entra").attr("visibility","hidden")}this.set_numbers_disposition()};function max_y(d){var c;var a=-100000000;for(c=0;c<d.length;++c){var b=parseFloat(d[c].y);if(b>a){a=b}}return a}dbd.data=function(i,E,d,A,F,f,r,x,B,b){var H=this.inner_h;this.draw_dates();var l=max_y(d);this.scale.detail.carbs=d3.scale.linear().domain([0,2.1*l]).range([this.r1,this.r2]);this.draw_carbs(d);this.draw_cgm(E);this.draw_bg(i);this.draw_bg_numbers(i);dbd.set_numbers_disposition();var D=max_y(A);this.scale.detail.bolus=d3.scale.linear().domain([0,2.1*D]).range([this.r2,this.r1]);this.draw_bolus(A);this.draw_events(f);this.draw_insmix(r);var w=this.find_fb_activity(dashboard_feed);this.draw_activity(x.concat(w));this.draw_rk(B);this.scale.stacked[0]=this.build_vscale(0,this.vh/4,this.scale.day.x,l,D);this.scale.stacked[1]=this.build_vscale(this.vh/4,2*this.vh/4,this.scale.day.x,l,D);this.scale.stacked[2]=this.build_vscale(2*this.vh/4,3*this.vh/4,this.scale.day.x,l,D);var G=telemetry.basal_stats(F);var t=G.max-G.min;var I=G.min;if(I<0){I=0}var a=G.max;this.scale.detail.basal=d3.scale.linear().domain([I*0.5,a*1.1]).range([this.r5,this.r4]);var C=telemetry.latest_basal_program();log("BASAL-PROGRAM");log(C);if(C==undefined){this.draw_basal_path(F)}else{var u=basal_program_to_ts(C);log(u);var c=telemetry.find_temp_basals(u,F);log(c);this.draw_basal_path(F,u);this.draw_temp_basal(c)}if(dashboard_feed!=undefined){var o;if(false){o=this.build_feed_data(dashboard_feed);this.draw_message(o,this.scale.detail)}else{log("build-feed-tread");log(dashboard_feed);o=this.build_feed_thread(dashboard_feed);if(false){var q=this.build_feed_thread(b);o=o.concat(q);mst_ts=_.sortBy(o,function(n){return n.x.getTime()})}this.draw_message_thread(o,this.scale.detail)}}var z=telemetry.find_isolated_highs(i,d,A);for(k in z){var h=z[k][0];var g=z[k][1];i[h].bg_bolus=A[g];A[g].bg=i[h]}var p=telemetry.find_covered_carbs(i,d,A);var y=p.length;for(k in p){var e=p[k][0];var g=p[k][1];d[e].carb_bolus=A[g];A[g].carb=d[e]}};var bg_arrow={half_width:9,height:14,notch:3};var sm_arrow={half_width:6,height:9,notch:1};function gen_arrow_down(g,f){var b=f.x(g.x);var h=f.bg(g);var c=bg_arrow;if(dbd.mode=="stacked"){c=sm_arrow}var e="M"+(b-c.half_width)+" "+(h-Math.round(c.height/2));e+="l"+c.half_width+" "+c.notch;e+="l"+c.half_width+" -"+c.notch;e+="l-"+c.half_width+" "+c.height;return e+"z"}function gen_arrow_up(g,f){var b=f.x(g.x);var h=f.bg(g);var c=bg_arrow;if(dbd.mode=="stacked"){c=sm_arrow}var e="M"+(b-c.half_width)+" "+(h+Math.round(c.height/2));e+="l"+c.half_width+" -"+c.notch;e+="l"+c.half_width+" "+c.notch;e+="l-"+c.half_width+" -"+c.height;return e+"z"}String.prototype.hashCode=function(){var b=0,a,d;if(this.length==0){return b}for(a=0;a<this.length;a++){d=this.charCodeAt(a);b=((b<<5)-b)+d;b=b&b}return b&2147483647};function gen_message_bubble(f,e){var a=e.x(f.x);var g=e.messages(0);var b=16;var c=10;var e=1.4;b*=e;c*=e;return cartoon_bubble_path(a,g-c,b,c,6*e,3*e,3*e)}dbd.create_message_pt=function(e){var f=e.from.name;var b="http://www.facebook.com/"+e.from.id;var a=new Date(e.created_time.replace("+0000","+00:00"));var d=e.message;var c='<p><b>From</b> <a href="'+b+'">'+f+"</a></p>";c+="<p><b>"+format_time(a)+" "+friendly_date(a)+"</b></p>";c+="<p>"+d+"</p>";return{x:a,y:c}};dbd.create_message_thread=function(e){var f=e.from.name;var b="http://www.facebook.com/"+e.from.id;var a=new Date(e.created_time.replace("+0000","+00:00"));var d=e.message;var c='<p><b>From</b> <a href="'+b+'">'+f+"</a></p>";c+="<p><b>"+format_time(a)+" "+friendly_date(a)+"</b></p>";c+="<p>"+d+"</p>";return{x:a,y:c}};dbd.build_feed_data=function(d){if(d==undefined){log("called build_feed_data with undefined feed!");return}var c=[];var b=d.data;for(k in b){var a=d.data[k];c.push(this.create_message_pt(a));if(a.comments!=undefined){var e=a.comments.data;for(v in e){var f=e[v];c.push(this.create_message_pt(f))}}}return c};dbd.find_fb_activity=function(d){log("find_fb_activity");log(fb);var c=[];var b=d.data;for(k in b){var a=d.data[k];log(a);var f=a.message;var h=f.indexOf("#activity");if(h>=0){}if(false){if(a.comments!=undefined){var e=a.comments.data;for(v in e){var g=e[v];c.push(this.create_message_pt(g))}}}}return c};dbd.build_feed_thread=function(n){var h=[];var q=n.data;var p=fb.get_selected_group().name;var l=fb.get_selected_group().id;var b="https://www.facebook.com/groups/"+l;for(k in q){var o=n.data[k];var a="modal"+k;var g="lab"+a;var d="";d+='<div class="modal" id="'+a+'" tabindex="-1" role="dialog" aria-labelledby="'+g+'" aria-hidden="true">';d+='<div class="modal-header">';d+='<h3 id = "'+g+'">';d+='<a href="'+b+'" target=_blank>';d+=p;d+="</a>";d+="</h3>";d+="</div>";d+='<div class="modal-body">';d+='<div id="md-'+o.id+'" class="modal-post">';d+=one_update(null,o,"post");if(o.comments!=undefined){var f=o.comments.data;for(v in f){var e=f[v];d+='<div class="modal-comment">';d+=one_update(null,e,"comment");d+="</div>"}}d+='<div id="modal-comment-'+o.id+'" class="modal-comment">';d+='<textarea onkeydown="modal_comment_key_handler(event)" class="commentbox" style="width:95%" id="nc-'+o.id+'" type="text" placeholder="Write comment..." rows="1"></textarea>';d+="</div>";d+="</div>";d+="</div>";d+='<div class="modal-footer">';d+='<button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>';d+="</div>";var c=new Date(o.created_time.replace("+0000","+00:00"));var i=false;if(n.omh!=undefined){i=true}h.push({x:c,y:d,mid:a,omh:i})}return h};dbd.draw_message=function(a,b){this.vis.selectAll(".message").data(a).enter().append("path").attr("d",function(c){return gen_message_bubble(c,b)}).attr("class","sp-detailed").attr("opacity","0.7").attr("fill",function(c){return c.omh?"white":"lightblue"}).attr("stroke","none").on("mouseover",function(g,c){var f=d3.select(this);var e=this.__data__.y;dbd.ctip.showTooltip(e,d3.event);d3.select(this).attr("stroke","black")}).on("mouseout",function(e,c){d3.select(this).attr("stroke","none");dbd.ctip.hideTooltip()})};dbd.draw_message_thread=function(b,c){var a=this.container;this.vis.selectAll(".message").data(b).enter().append("path").attr("d",function(e){return gen_message_bubble(e,c)}).attr("class","sp-detailed").attr("opacity","0.7").attr("fill",function(e){return e.omh?"white":"lightblue"}).attr("stroke","none").on("click",function(h,e){var g=d3.select(this);var f=this.__data__.y;d3.select("#modal-container").remove();var l=a.append("div");l.attr("id","modal-container");l[0][0].innerHTML=f;$("#"+this.__data__.mid).modal("show")}).on("mouseover",function(f,e){d3.select(this).attr("stroke","white");d3.select(this).attr("fill","#ddd")}).on("mouseout",function(f,e){d3.select(this).attr("stroke","none");d3.select(this).attr("fill",function(g){return g.omh?"white":"lightblue"})})};function entra_class(c,b){var a=b;if(c.glucose!=undefined){a+=" entra"}return a}dbd.draw_bg=function(f){if(dbd.eMode){this.vis.selectAll(".BG-normal").data(f).enter().append("circle").attr("class","BG BG-normal").attr("opacity","0.65").attr("fill",function(h,g){return bg_color(h)})}var c=f.filter(function(g){return(g.y<75)});var e=f.filter(function(g){return(g.y>=75&&g.y<180)});var a=f.filter(function(g){return(g.y>=180)});var d=this.vis.append("g").attr("id","bg-g");function b(g){return(g.glucose!=undefined)?"0.15":"0.65"}d.selectAll(".BG-low").data(c).enter().append("path").attr("class",function(g){return entra_class(g,"BG BG-low")}).attr("opacity",b).attr("stroke","none").attr("stroke-width","0.75px").attr("fill",function(h,g){return bg_color(h)});d.selectAll(".BG-high").data(a).enter().append("path").attr("class",function(g){return entra_class(g,"BG BG-high")}).attr("opacity",b).attr("stroke","none").attr("stroke-width","0.75px").attr("fill",function(h,g){return bg_color(h)});d.selectAll(".BG-normal").data(e).enter().append("circle").attr("class",function(g){return entra_class(g,"BG BG-normal")}).attr("opacity",b).attr("stroke","none").attr("stroke-width","0.75px").attr("fill",function(h,g){return bg_color(h)})};dbd.place_bg=function(b,c,a){this.place_bg_circles(b.filter(".BG-normal").transition(),c,function(d){return a});this.place_bg_arrows(b.filter(".BG-low").transition(),c,gen_arrow_down);this.place_bg_arrows(b.filter(".BG-high").transition(),c,gen_arrow_up);dbd.set_bg_mouseover(c);this.set_entra_disposition()};dbd.place_bg_circles=function(b,c,a){b.attr("cx",function(e){return c.x(e.x)}).attr("cy",function(e){return c.bg(e)}).attr("r",function(e){return a(e.y)})};dbd.place_bg_arrows=function(a,c,b){a.attr("d",function(e){return b(e,c)})};dbd.set_bg_mouseover=function(a){d3.selectAll(".BG").on("mouseover",function(e,b){var c=d3.select(this);tooltip.enable(c,format_time_bg_data(this.__data__));var e=this.__data__;if(dbd.mode=="detailed"){if(e.bg_bolus!=undefined){dbd.draw_bg_bolus_association(e,e.bg_bolus,a)}}}).on("dblclick",function(e,b){if(dbd.mode=="detailed"){$("#daily_tab a").click();return}var c=this.__data__.x;dbd.click_to_detailed(c)}).on("mouseup",function(c,b){tooltip.unlock()}).on("mouseout",function(c,b){tooltip.disable()})};dbd.place_cgm=function(b,d,c){var a=d.bg;if(d.cgm!=undefined){a=d.cgm}b.attr("cx",function(e){return d.x(e.x)}).attr("cy",function(e){return a(e)}).attr("r",c);b.on("mouseover",function(g,e){var f=d3.select(this);tooltip.enable(f,format_time_bg_data(this.__data__))}).on("mouseup",function(f,e){tooltip.unlock()}).on("mouseout",function(f,e){tooltip.disable()})};dbd.draw_cgm=function(a){if(dbd.eMode){this.vis.selectAll(".BG-normal").data(a).enter().append("circle").attr("class","BG BG-normal").attr("opacity","0.65").attr("fill",function(c,b){return bg_color(c)})}this.vis.selectAll(".CGM").data(a).enter().append("circle").attr("class","CGM sp-detailed sp-hourly").attr("opacity","0.45").attr("stroke","none").attr("stroke-width","0.75px").attr("fill",function(c,b){return bg_color(c)})};dbd.draw_bg_numbers=function(b){var a=d3.select("#bg-g");a.selectAll("BGnum").data(b).enter().append("text").attr("class",function(c){return(c.glucose!=undefined)?"BG-text BG-text-entra":"BG-text"}).attr("text-anchor","middle").attr("opacity","0.4").attr("fill","white").text(function(c){return Math.round(c.y)})};dbd.place_bg_numbers=function(b,c,a){var d=(a>=1)?13:9;b.transition().attr("x",function(e){return c.x(e.x)}).attr("y",function(e){return c.bg(e)-d}).attr("font-size",(a*100)+"%")};dbd.build_vscale=function(l,g,c,i,a){var b={x:c};var f=g-l;var d=0.6;var e=d3.scale.linear().domain([40,360]).range([l+f*d,l]);b.bg=function(h){return e(limit(h.y,40,350))};b.carbs=d3.scale.linear().domain([0,i*2.1]).range([l+f*d,g]);b.bolus=d3.scale.linear().domain([0,2.1*a]).range([g,l+f*d]);b.day=function(h){return l+0.5*(g-l)};return b};dbd.select_by_day=function(a,b){var d=b.getTime();var c=add_days(b,1).getTime();return d3.selectAll(a).select(function(f){var e=f.x.getTime();return(e>=d&&e<c)?this:null})};dbd.select_by_day_direct=function(a,b){var d=b.getTime();var c=add_days(b,1).getTime();return d3.selectAll(a).select(function(f){var e=f.getTime();return(e>=d&&e<c)?this:null})};dbd.show_stacked_bgnums=function(){var c=sort_dates(dbd.selected_dates());var a;for(a=0;a<c.length;++a){var b=this.select_by_day(".BG-text",c[a]);b.attr("visibility","visible")}};dbd.set_mode=function(g){if(g==this.mode){return}this.mode=g;d3.selectAll(".sp-detailed,.sp-daily,.sp-hourly,.sp-stacked").attr("visibility","hidden");d3.selectAll(".BG,.BG-text").attr("visibility","visible");dbd.set_numbers_disposition();var d=this;if(g=="daily"){d3.selectAll(".sp-daily").attr("visibility","visible");this.set_pan(0,false);var d=this;var f=this.scale.day;var b=f.x;var c=function(i){return d.yscale_day(noon(i.x))};this.place_bg(d3.selectAll(".BG"),f,8);this.place_bg_numbers(d3.selectAll(".BG-text"),f,1.1);this.place_cgm(d3.selectAll(".CGM"),f,1);var a=function(i){return d.yscale_day(noon(i))};this.place_day_legend(d3.selectAll(".day_legend_day").transition(),-8,a);this.place_day_legend(d3.selectAll(".day_legend_date").transition(),8,a)}else{if(g=="hourly"){d3.selectAll(".sp-hourly").attr("visibility","visible");this.set_pan(0,false);var f=this.scale.hour;this.place_bg(d3.selectAll(".BG"),f,8);this.place_bg_numbers(d3.selectAll(".BG-text"),f,1.1);this.place_cgm(d3.selectAll(".CGM"),f,1)}else{if(g=="detailed"){d3.selectAll(".sp-detailed").attr("visibility","visible");this.position_viewer_at(this.viewer_date,false);var f=this.scale.detail;this.place_bg(d3.selectAll(".BG"),f,8);this.place_bg_numbers(d3.selectAll(".BG-text"),f,1.1);this.place_cgm(d3.selectAll(".CGM"),f,2.5);this.place_carbs(d3.selectAll(".carbs"),f);this.place_bolus(d3.selectAll(".bolus"),f);this.place_events(d3.selectAll(".pumpevents"),f);this.place_insmix(d3.selectAll(".insmix"),f);this.place_activity(d3.selectAll(".activity"),f);this.place_rk(d3.selectAll(".rk"),f)}else{if(g=="stacked"){this.set_pan(0,false);d3.selectAll(".BG,.BG-text").attr("visibility","hidden");d3.selectAll(".sp-stacked").attr("visibility","visible");var h=sort_dates(dbd.selected_dates());for(k=0;k<h.length;++k){var f=this.scale.stacked[k];var e;e=this.select_by_day(".BG",h[k]);e.attr("visibility","visible");this.place_bg(e,f,6);e=this.select_by_day(".BG-text",h[k]);if($("#checkbox_show_numbers").prop("checked")){e.attr("visibility","visible")}this.place_bg_numbers(e,f,0.9);e=this.select_by_day(".carbs",h[k]);e.attr("visibility","visible");this.place_carbs(e,f);e=this.select_by_day(".bolus",h[k]);e.attr("visibility","visible");this.place_bolus(e,f);e=this.select_by_day_direct(".day_legend_day",h[k]);e.attr("visibility","visible");this.place_day_legend(e.transition(),-8,f.day);e=this.select_by_day_direct(".day_legend_date",h[k]);e.attr("visibility","visible");this.place_day_legend(e.transition(),8,f.day);if(false){this.place_events(d3.selectAll(".pumpevents"),dbd.xscale_day,dbd.yscale_basal,dbd.yscale_insulin);this.place_insmix(d3.selectAll(".insmix"),dbd.xscale_day,dbd.yscale_basal)}}}else{return}}}}};dbd.draw_day_grid=function(b,a){this.vis.selectAll(".day_grid").data(this.dateRange).enter().append("line").attr("class","day_grid sp-daily").attr("stroke","#ccc").attr("stroke-width","1px").attr("opacity","0.25").attr("x1",b).attr("y1",function(c){return(dbd.yscale_day(c))}).attr("x2",a).attr("y2",function(c){return(dbd.yscale_day(c))})};dbd.draw_stacked_grid=function(e,c){var d=this.vis;var a;for(a=0;a<3;++a){var b=this.scale.stacked[a];var f={y:40};d.append("line").attr("class","stacked_grid sp-stacked").attr("stroke","#ccc").attr("stroke-width","1px").attr("opacity","0.25").attr("x1",e).attr("y1",function(g){return(b.bg(f))}).attr("x2",c).attr("y2",function(g){return(b.bg(f))});d.append("line").attr("class","stacked_grid sp-stacked").attr("stroke","#ccc").attr("stroke-width","4px").attr("opacity","1").attr("x1",e).attr("y1",function(g){return(b.bolus(0))}).attr("x2",c).attr("y2",function(g){return(b.bolus(0))})}};dbd.draw_vbg_grid=function(b,a){var c=this.scale.detail;this.vis.selectAll(".vbg_grid").data([{y:80},{y:180}]).enter().append("line").attr("class","vbg_grid sp-detailed").attr("stroke","#ccc").attr("stroke-dasharray","2,5").attr("stroke-width","1.5px").attr("opacity","0.2").attr("x1",b).attr("y1",function(e){return(c.bg(e))}).attr("x2",a).attr("y2",function(e){return(c.bg(e))});this.vis.append("line").attr("class","vbg_grid sp-detailed").attr("stroke","#ccc").attr("stroke-width","1.5px").attr("opacity","0.25").attr("x1",b).attr("y1",function(e){return(c.bg({y:40}))}).attr("x2",a).attr("y2",function(e){return(c.bg({y:40}))})};dbd.draw_bolus_grid=function(b,a){var c=this.scale.detail;this.vis.selectAll(".insulin_grid").data([0]).enter().append("line").attr("class","insulin_grid sp-detailed").attr("stroke","#ccc").attr("stroke-width","1.5px").attr("opacity","0.25").attr("x1",b).attr("y1",function(e){return(c.bolus(e))}).attr("x2",a).attr("y2",function(e){return(c.bolus(e))})};dbd.draw_bg_grid=function(b,a){var c=this.scale.hour;this.vis.selectAll(".bg_grid").data([{y:80},{y:180}]).enter().append("line").attr("class","bg_grid sp-hourly").attr("stroke","#ccc").attr("stroke-width","1px").attr("opacity","0.25").attr("x1",b).attr("y1",function(e){return(c.bg(e))}).attr("x2",a).attr("y2",function(e){return(c.bg(e))})};function gen_x_path(a,e,b,c){var d="M"+a+" "+e;d+="L"+(a+b)+" "+(e+c);d+="M"+(a+b)+" "+e;d+="L"+a+" "+(e+c);return d}var cb={};cb.max=3;cb.n=0;cb.lookup=function(b){var a=0;for(a=0;a<cb.n;++a){var c=cb.box[a];if(b==c.key){return c}}return null};cb.remove_oldest=function(){if(cb.n<=0){return null}cb.n-=1;return cb.box[cb.n-1]};cb.click=function(d,a,f){var e=cb.lookup(d);if(e!=null){if(e.active){e.active=false;e.deselect()}else{e.active=true;e.select()}}else{if(cb.n>=cb.max){var c=cb.remove_oldest();c.deselect()}var b;for(b=1;b<cb.n;++b){cb.box[b]=cb.box[b-1]}var e={key:d,select:a,deselect:f,active:true};cb.box[0]=e;cb.n+=1;e.select()}return e};dbd.draw_day_legend=function(){var b=this.y_legend.selectAll("day_legend").data(this.dateRange).enter();b.append("text").attr("class","sp-daily day_legend_day").attr("font-size","85%").attr("text-anchor","middle").text(function(e){return weekday(e)});b.append("text").attr("class","sp-daily day_legend_date").attr("font-size","85%").attr("text-anchor","middle").text(function(e){return friendly_date4(e)});var a=5;var c=this.dateRange};dbd.place_day_legend=function(f,e,d){var c=5;var b=this.y_legend_width/2+c;var a=2;f.attr("x",b).attr("y",function(g){return d(g)+e+a})};dbd.selected=function(){var a=d3.selectAll(".day_checkbox_marker");return a[0]};dbd.lookup_checkbox=function(c){var b=midnight(c);var h=b.getTime();var g=add_days(b,1).getTime();var e=this.selected();if(e.length<=0){return null}var a;for(a=0;a<e.length;++a){var f=e[a];var d=f.__data__.getTime();if(d>=h&&d<g){return f}}return null};dbd.selected_dates=function(){var b=this.selected();var a;var c=[];for(a=0;a<b.length;++a){c.push(b[a].__data__)}return c};dbd.draw_checkboxes=function(b,a){b.append("rect").attr("class","sp-daily day_checkbox").attr("x",2).attr("y",function(c){return dbd.yscale_day(noon(c))-a}).attr("rx",0.5*a).attr("ry",0.5*a).attr("width",2*a).attr("height",2*a).attr("stroke","black").attr("stroke-width","1.5px").attr("fill","none").attr("pointer-events","all").on("mouseover",function(f,c){var e=d3.select(this);e.attr("stroke-width","2.2px")}).on("click",function(h,f){var g=d3.select(this);var e=this.__data__;var g=dbd.lookup_checkbox(e);if(g!=null){d3.select(g).remove()}else{var c=dbd.selected();if(c.length>=3){d3.select(c[0]).remove()}dbd.draw_checkbox_mark(e,a)}}).on("mouseout",function(f,c){var e=d3.select(this);e.attr("stroke-width","1.5px")})};dbd.draw_checkbox_mark=function(a,b){this.y_legend.selectAll("none").data([a]).enter().append("path").attr("class","sp-daily day_checkbox_marker").attr("d",function(c){return gen_x_path(2,dbd.yscale_day(noon(c))-b,2*b,2*b)}).attr("stroke","black").attr("fill","none")};dbd.draw_bg_legend=function(){var b=this.scale.hour.bg;var a=this.y_legend_width/2;this.y_legend.selectAll("bg_legend").data([{y:40},{y:60},{y:80},{y:100},{y:120},{y:140},{y:160},{y:180},{y:200},{y:220},{y:240},{y:260},{y:280},{y:300},{y:320},{y:340}]).enter().append("text").attr("class","sp-hourly").attr("font-size","85%").attr("x",a).attr("y",function(c){return b(c)}).attr("text-anchor","middle").text(function(c){return c.y})};dbd.draw_detail_legend=function(){var b=this.scale.detail.bg;var a=this.y_legend_width/2;this.y_legend.selectAll("detail_bg_legend").data([{y:60},{y:100},{y:140},{y:180},{y:220},{y:260},{y:300},{y:340}]).enter().append("text").attr("class","sp-detailed").attr("font-size","85%").attr("x",a).attr("y",function(c){return b(c)}).attr("text-anchor","middle").text(function(c){return c.y});return;this.y_legend.selectAll("detail_bolus_legend").data([{y:1},{y:2},{y:3},{y:4},{y:5},{y:6},{y:7},{y:8}]).enter().append("text").attr("class","sp-detailed").attr("font-size","85%").attr("x",a).attr("y",this.scale.detail.bolus).attr("text-anchor","middle").text(function(c){return c});this.y_legend.selectAll("detail_basal_legend").data([0.2,0.4,0.6,0.8,1,1.2]).enter().append("text").attr("class","sp-detailed").attr("font-size","85%").attr("x",a).attr("y",this.scale.detail.basal).attr("text-anchor","middle").text(function(c){return c})};dbd.set_color_mode=function(a){if(dbd.color_mode==a){return}dbd.color_mode=a;if(dbd.color_mode=="simple"){this.vis.selectAll(".BG-low,.BG-normal,.BG-high").transition().attr("r",10).attr("fill",function(c,b){return bg_color(c)})}else{this.vis.selectAll(".BG-low,.BG-normal,.BG-high").transition().attr("r",function(b){return bg_to_radius(b.y)}).attr("fill",function(c,b){return bg_to_color(c.y)})}};dbd.draw_dates=function(){var d=this.vis;var c=24*this.ndays;var b;var a=this.sdate;for(b=0;b<c;b+=24){var f=d3.time.hour.offset(a,b);var e=d.append("text");e.attr("x",this.scale.detail.x(f)).attr("y",26).attr("font-size","130%").attr("text-anchor","start").attr("fill","white").attr("opacity","0.4").text(friendly_date2(f)+" ->");e.attr("class","sp-detailed")}};dbd.draw_carbs=function(a){this.vis.selectAll("carbs").data(a).enter().append("rect").attr("class","carbs sp-detailed").attr("stroke","none").attr("stroke-width","0.75px")};dbd.place_carbs=function(b,d){var c=8;var a=d.carbs;b.attr("x",function(e){return d.x(e.x)-c/2}).attr("y",function(e){return a(0)}).attr("rx",c/4).attr("ry",c/4).attr("width",c).attr("height",function(e){return a(e.y)-a(0)}).on("mouseover",function(g,e){var f=d3.select(this);var g=this.__data__;tooltip.enable(f,format_time_carb_data(g));if((dbd.mode=="detailed"||dbd.mode=="stacked")&&g.carb_bolus!=undefined){dbd.draw_carb_bolus_association(g,g.carb_bolus,d)}}).on("mouseup",function(f,e){tooltip.unlock()}).on("mouseout",function(f,e){tooltip.disable()})};dbd.format_event_string=function(d){var b,c,e,g,a,i,f;var h=d.split(",");for(k in h){if(h[k]=="alarm"){b=true}else{if(h[k]=="resume"){e=true}else{if(h[k]=="suspend"){c=true}else{if(h[k]=="prime"){g=true}else{if(h[k]=="fillC"){a=true}else{if(h[k]=="run"){i=true}else{if(h[k]=="walk"){f=true}}}}}}}}var l="";if(b!=undefined){l+="A"}if(c!=undefined){l+="S"}if(e!=undefined){l+="R"}if(g!=undefined){l+="P"}if(a!=undefined){l+="C"}if(i!=undefined){l+="*R"}if(f!=undefined){l+="*W"}return l};dbd.draw_events=function(a){this.vis.selectAll("pumpevents").data(a).enter().append("text").attr("class","pumpevents sp-detailed").attr("font-size","105%").attr("text-anchor","middle").attr("fill","white").attr("opacity","0.5").text(function(b){return dbd.format_event_string(b.y)})};dbd.place_events=function(b,c){var a=10;b.attr("x",function(e){return c.x(add_minutes(e.x,30))}).attr("y",function(e){return c.events(0)+a})};function dbd_largest_date_smaller_than(e,b){var a=0;while(a<e.length){var c=e[a].x;if(c>b){return a-1}a=a+1}return e.length}function dbd_basal_invert(c,b){var a=dbd_largest_date_smaller_than(c,b);if(a<0||a>=c.length){return undefined}return[c[a],c[a+1]]}dbd.draw_basal=function(a){for(k in a){this.draw_basal_day(a[k])}};dbd.draw_basal_path=function(i,e){var d=this.scale.detail;var c=d3.svg.area().x(function(l){return d.x(l.x)}).y0(d.basal(0)).y1(function(l){return d.basal(l.y)}).interpolate("step-after");var b=d3.svg.line().x(function(l){return d.x(l.x)}).y(function(l){return d.basal(l.y)}).interpolate("step-after");var g=this.vw;var a=this.vis;var h=a.append("svg:path").attr("class","basal sp-detailed").attr("d",c(i)).style("stroke","none").on("mousemove",function(r,q){var o=d3.svg.mouse(this);var u=o[0];var p=u/(g*dbd.ndays)*(24*dbd.ndays);var l=d3.time.minute.offset(dbd.sdate,p*60);var w=dbd_basal_invert(i,l);var t=d3.select(this);var n=format_time_basal_data(w[0],w[1]);tooltip.enable(t,n)}).on("mouseup",function(n,l){tooltip.unlock()}).on("mouseout",function(n,l){tooltip.disable()});$("#dasboard-warning-text").remove();if(e!=undefined&&i&&i.length!=0){var f=basal_program_to_pts(e,midnight(i[0].x),midnight(i[i.length-1].x));a.append("svg:path").attr("class","basal sp-detailed").attr("stroke","white").attr("stroke-width","1.5px").attr("stroke-dasharray","4,1").style("fill","none").style("opacity","1").attr("d",b(f))}else{$("#dashboard").prepend('<div id=dasboard-warning-text style="text-align:center;color:orange"> Warning: no Pump information for this time range.</div>')}};dbd.draw_bolus=function(a){this.vis.selectAll("bolus").data(a).enter().append("g").attr("class","bolus sp-detailed");var b=d3.selectAll(".bolus");b.append("rect").attr("class","bolus-amount sp-detail").attr("stroke","none").attr("stroke-width","0.75px").attr("opacity","0.8");var c=b.filter(function(e){return e.calculated!=undefined});c.append("rect").attr("class","bolus-override sp-detail").attr("fill","white")};dbd.place_bolus=function(b,d){var c=8;var a=d.bolus;b.selectAll(".bolus-amount").attr("x",function(e){return d.x(e.x)-c/2}).attr("y",function(e){return a(e.y)}).attr("rx",c/4).attr("ry",c/4).attr("width",c).attr("height",function(e){return a(0)-a(e.y)});b.on("mouseover",function(g,e){var f=d3.select(this);tooltip.enable(f,format_time_insulin_data(this.__data__));var g=this.__data__;if(dbd.mode=="detailed"||dbd.mode=="stacked"){if(g.bg!=undefined){dbd.draw_bg_bolus_association(g.bg,g,d)}if(g.carb!=undefined){dbd.draw_carb_bolus_association(g.carb,g,d)}}}).on("mouseup",function(f,e){tooltip.unlock()}).on("mouseout",function(f,e){tooltip.disable()});b.selectAll(".bolus-override").attr("x",function(e){return d.x(e.x)-c/2}).attr("y",function(e){return a(e.calculated)}).attr("width",c).attr("height",c/2)};dbd.draw_bg_bolus_association=function(a,b,c){this.vis.append("line").attr("class","remove-with-tooltip").attr("x1",c.x(a.x)).attr("y1",c.bg(a)+10).attr("x2",c.x(b.x)).attr("y2",c.bolus(b.y)-10).attr("stroke","#ccc").attr("stroke-width","1px").attr("stroke-dasharray","3,5").attr("opacity","1");this.vis.append("text").attr("class","remove-with-tooltip").attr("x",(c.x(a.x)+c.x(b.x))/2).attr("y",(c.bolus(b.y)+c.bg(a))/2).attr("text-anchor","middle").attr("fill","white").text(format_time_ihigh_data(a,b))};dbd.draw_carb_bolus_association=function(a,b,c){this.vis.append("line").attr("class","remove-with-tooltip").attr("x1",c.x(a.x)).attr("y1",c.carbs(a.y)+10).attr("x2",c.x(b.x)).attr("y2",c.bolus(b.y)-10).attr("stroke","#ccc").attr("stroke-width","1px").attr("stroke-dasharray","3,5").attr("opacity","1");this.vis.append("text").attr("class","remove-with-tooltip").attr("x",(c.x(a.x)+c.x(b.x))/2).attr("y",(c.bolus(b.y)+c.carbs(a.y))/2).attr("text-anchor","middle").attr("fill","white").text(format_time_carb_cover(a,b))};dbd.draw_temp_basal=function(a){for(k in a){dbd.draw_one_temp_basal(a[k])}};dbd.draw_one_temp_basal=function(g){var f=this.scale.detail;var a=d3.svg.area().x(function(h){return f.x(h.actual.x)}).y0(function(h){return f.basal(h.actual.y)}).y1(function(h){return f.basal(h.program)}).interpolate("step-after");var d=d3.svg.line().x(function(h){return f.x(h.actual.x)}).y(function(h){return f.basal(h.program)}).interpolate("step-after");var c=this.vw;var b=this.vis;var e=b.append("svg:path").attr("class","temp_basal sp-detailed").attr("fill","white").attr("opacity","0").attr("d",a(g)).on("mousemove",function(r,p){var y=d3.select(this);var u=format_time(g[0].actual.x);var w=format_time(g[g.length-1].actual.x);var l="temp basal "+u+" to "+w;tooltip.enable(y,l);return;var n=d3.svg.mouse(this);var x=n[0];var o=x/(c*this.ndays)*(24*this.ndays);var h=d3.time.minute.offset(dbd.sdate,o*60);var t=dbd_basal_invert(g,h);var q=d3.select(this);var l=format_time_basal_data(t[0],t[1]);tooltip.enable(q,l)}).on("mouseup",function(l,h){tooltip.unlock()}).on("mouseout",function(l,h){tooltip.disable()})};function gen_html_insmix(e){var g=Math.round(e.y*100);var f=Math.round(e.y*e.s*10)/10;var b=Math.round((1-e.y)*e.s*10)/10;var c=friendly_date2(e.x);var a="";a+="<b>"+c+" - daily total</b>";a+="<table>";a+="<tr>";a+="<td><i>bolus insulin: </i></td>";a+='<td align="right">'+b+"U </td>";a+='<td align="right">('+(100-g)+"%)</td>";a+="</tr>";a+="<tr>";a+="<td><i>basal insulin: </i></td>";a+='<td align="right">'+f+"U </td>";a+="<td>("+g+"%)</td>";a+="</tr>";a+="</table>";return a}dbd.draw_insmix=function(b){this.vis.selectAll("insmix").data(b).enter().append("g").attr("class","insmix sp-detailed").attr("stroke","white").on("mouseover",function(g,c){var f=d3.select(this);var e=gen_html_insmix(this.__data__);dbd.ctip.showTooltip(e,d3.event);d3.select(this).attr("stroke-width","2px")}).on("mouseout",function(e,c){d3.select(this).attr("stroke-width","1px");dbd.ctip.hideTooltip()});var a=d3.selectAll(".insmix");a.append("path").attr("class","insmix-basal sp-detail");a.append("path").attr("class","insmix-bolus sp-detail")};dbd.place_insmix=function(b,e){var g=e.insmix(0)+10;b.attr("transform",function(i){var h=e.x(add_minutes(i.x,23.5*60));return"translate("+h+","+g+")"});var a=12;var d=Math.PI/2;var f=d3.svg.arc().startAngle(d).endAngle(function(h){return(d+2*Math.PI*h.y)}).innerRadius(0).outerRadius(a);var c=d3.svg.arc().startAngle(function(h){return(d+2*Math.PI*h.y)}).endAngle(2*Math.PI+d).innerRadius(0).outerRadius(a);d3.selectAll(".insmix-basal").attr("d",f);d3.selectAll(".insmix-bolus").attr("d",c)};dbd.draw_activity=function(a){this.vis.selectAll("activity").data(a).enter().append("rect").attr("class","activity sp-detailed").attr("opacity","0.4").on("mouseover",function(c,b){}).on("mouseout",function(c,b){})};dbd.place_activity=function(b,c){var a=3;var d=c.bg({y:65});b.attr("x",function(e){return c.x(e.x)-3}).attr("y",d).attr("width",2*a).attr("height",2*a).attr("fill",function(e){if(e.y=="walk"){return"yellow"}if(e.y=="run"){return"red"}return"purple"})};dbd.draw_rk=function(a){this.vis.selectAll("rk").data(a).enter().append("rect").attr("class","rk sp-detailed").attr("opacity","0.65").on("mouseover",function(h,c){var g=this.__data__.y;var b=Math.round(g.duration/60);var f=g.type+" for "+b+"minutes";var e=d3.select(this);tooltip.enable(e,f)}).on("mouseout",function(c,b){tooltip.disable()})};dbd.place_rk=function(c,f){var b=3;var e=f.bg({y:80});var d=f.bg({y:40})-e;var a=d*0.45;var h=(d-a)/2;var g=e+h;c.attr("x",function(i){return f.x(i.x)}).attr("y",g).attr("rx",a/4).attr("ry",a/4).attr("width",function(o){var l=o.y.duration;var i=o.x.getTime()+l*1000;var n=new Date();n.setTime(i);return f.x(n)-f.x(o.x)}).attr("height",a).attr("fill","lightblue")};var src_interval_timer=null;var spinner=null;var sync_in_progress=false;function show_spinner(){var a;var c;var d=$("#sync-pump-div").get(0);if(!spinner){var b={lines:13,length:5,width:4,radius:10,corners:1,rotate:0,color:"#000",speed:1,trail:60,shadow:false,hwaccel:false,className:"spinner",zIndex:2000000000,top:10,left:"auto"};spinner=new Spinner(b).spin(d)}else{spinner.spin(d)}sync_in_progress=true;$("#sync-pump-button").attr("class","btn btn-large btn-success disabled");$("#sync-settings-button").attr("class","btn btn-large btn-primary disabled")}function hide_spinner(){var a;var b;if(spinner){spinner.stop()}sync_in_progress=false;$("#sync-pump-button").attr("class","btn btn-large btn-success");$("#sync-settings-button").attr("class","btn btn-large btn-primary")}function src_success_cb(a,b){var c=new Date();c.setTime(a.last_fetch_time);$("#sync-status-text").text(" Success").attr("class"," icon-ok-sign").attr("style","color: green;");$("#sync-time-text").text(c);hide_spinner();set_fb_group(fb.get_selected_group().name,"The new data for this device has been succesfully downloaded and is now included in the dashboard.","Success!","alert alert-success")}function sync_modal_dismiss(){set_fb_group(fb.get_selected_group().name,"The data for the device has not been updated.","Sync Canceled","alert alert-error")}function ask_pw_modal(c,e){var d=$("#spa_root").get(0);var a=$.el;$("#device-modal").remove();a.div({id:"device-modal","class":"modal hide fade",tabindex:"-1",role:"dialog","aria-labelledby":"myModalLabel","aria-hidden":"true"},a.div({"class":"modal-header"},a.button({type:"button","class":"close","data-dismiss":"modal"},"Ã—"),a.h3("Password Required")),a.div({"class":"modal-body"},a.form(a.p(a.input({id:"sync-params-pass",style:"width:50%",type:"password",placeholder:"Password"}))),a.p({id:"newdevice-error-text",style:"color:red;"})),a.div({"class":"modal-footer"},a.button({"class":"btn","data-dismiss":"modal",onclick:"sync_modal_dismiss()","aria-hidden":"true"},"Cancel"),a.button({"class":"btn btn-primary",onclick:'create_sync_page("'+e+'")'},"Sync"))).appendTo(d)}function src_failure_pw(b){pass=null;if(!pass){$("#device-modal").modal("hide");clearInterval(src_interval_timer);hide_spinner();var a=JSON.parse(b.responseText);ask_pw_modal(a.type,a.id);$("#device-modal").data("id",a.id);$("#device-modal").modal()}}function src_failure_cb(c){if(c.status===409){$("#sync-status-text").text(" In progress").attr("class"," icon-circle-arrow-down").attr("style","color: #F88017;");$("#sync-time-text").text("n.a.");show_spinner()}else{if(c.status===400){var a=$.parseJSON(c.responseText);var b=new Date();b.setTime(a.last_fetch_time);$("#sync-status-text").text(" sync failed, check your password").attr("class"," icon-exclamation-sign").attr("style","color: #C11B17;");$("#sync-time-text").text(b);hide_spinner();src_failure_pw(c)}else{if(c.status===404){$("#sync-status-text").text(" pump not synced yet").attr("class"," icon-exclamation-sign").attr("style","color: #C11B17;");$("#sync-time-text").text("n.a.");hide_spinner()}else{if(c.status===401){src_failure_pw(c)}else{$("#sync-status-text").text(" No connection to blip").attr("class"," icon-exclamation-sign").attr("style","color: #C11B17;");$("#sync-time-text").text("n.a.");hide_spinner()}}}}}function poll_src_sync_status(a){var c=fb.get_selected_group();var b="/api/"+api_v_str+"/groups/"+c.id+"/sources/"+a.id;url=prefixify(b,["sync"],[],true)[0];url+=("&user="+a.user+"&pass="+a.pass);$.ajax({type:"GET",url:url,dataType:"json",success:src_success_cb,error:src_failure_cb,data:{},async:true})}function do_src_sync(d){console.log("syncing is disabled");return;var b;var c;var g=d.id;if(sync_in_progress){return}$("#sync-status-text").text(" In progress").attr("class"," icon-circle-arrow-down").attr("style","color: #F88017;");$("#sync-time-text").text("n.a.");show_spinner();var f=fb.get_selected_group();var e="/api/"+api_v_str+"/groups/"+f.id+"/sources/"+g;c=prefixify(e,["sync"],[],false)[0];var a=create_rest_body();if($("#sync-params-pass").length!==0&&$("#sync-params-pass").get(0).value!==""){a.pass=$("#sync-params-pass").get(0).value;$("#sync-params-pass").get(0).value=""}else{if($("#src-params-pass").length!==0&&$("#src-params-pass").get(0).value!==""){a.pass=$("#src-params-pass").get(0).value;$("#src-params-pass").get(0).value=""}}$.ajax({type:"POST",url:c,dataType:"json",error:function(h){if(h.status!==409){clearInterval(src_interval_timer);$("#sync-status-text").text(" Connection error. Please reload the page.").attr("class"," icon-exclamation-sign").attr("style","color: #C11B17;");$("#sync-time-text").text("n.a.");hide_spinner()}},data:a,async:true})}function create_sync_page(i){var e;var h;var g;$("#device-modal").modal("hide");if(i===""){g="Syncing All"}else{var d=srclist.get(i);h=[d];g="Syncing Data Source"}var f=sb_reset();do_src_sync(h[0]);var a=$.el;var c=a.div({"class":"well"},a.div({"class":"col1",id:"sync-pump-div"},a.div({"class":"page-header"},a.h2(g))));for(e=0;e<h.length;e++){a.div({"class":"well"},a.h4(h[e].desc),a.i(h[e].website),a.b("Last sync time: "),a.span({id:"sync-time-text"},"n.a."),a.p(a.b("Last sync status: "),a.i({id:"sync-status-text","class":"icon-circle-arrow-down",style:"color: #F88017;"}," In progress"))).appendTo(c)}c.appendTo(f);show_spinner();poll_src_sync_status(h[0]);src_interval_timer=setInterval(function(){poll_src_sync_status(h[0])},1000);active_timers.push(src_interval_timer)}function add_device(){var d={};var c=$("#device-modal").data("type");for(var b in source_type[c].params){var e=source_type[c].params[b];d[e.id]=$("#src-params-"+e.id).get(0).value;if(e.required){if(d[e.id]===""){$("#newdevice-error-text").text("Please specify the "+e.name+" parameter");return}}if(e.type==="ShortString"){if(d[e.id].length>10){$("#newdevice-error-text").text('The "'+e.name+'" parameter cannot be longer than 10 characters');return}}}$("#device-modal").modal("hide");var a=srclist.add(c,d);if(a!==null){spa_build_home("The new device has been successfully added and its data is being downloaded.","Device Added","alert alert-success");create_sync_page(a)}else{spa_build_home("Device creation failed.","Failure!","alert alert-error")}}function build_device_settings_modal(g,c){var f=$("#spa_root").get(0);var h=$.el;var d=source_type[g];$("#device-modal").remove();var i=h.fieldset();for(var e in source_type[g].params){var a=source_type[g].params[e];var l;if(a.type==="PasswordString"){l="password"}else{l="text"}h.p(h.input({id:"src-params-"+a.id,style:"width:50%",type:l,placeholder:a.name})).appendTo(i)}h.div({id:"device-modal","class":"modal hide fade",tabindex:"-1",role:"dialog","aria-labelledby":"myModalLabel","aria-hidden":"true"},h.div({"class":"modal-header"},h.button({type:"button","class":"close","data-dismiss":"modal"},"Ã—"),h.h3(d.desc+" Settings")),h.div({"class":"modal-body"},h.form(i),h.p({id:"newdevice-error-text",style:"color:red;"})),h.div({"class":"modal-footer"},h.button({"class":"btn","data-dismiss":"modal","aria-hidden":"true"},"Cancel"),h.button({"class":"btn btn-primary",onclick:"add_device()"},"Add Device"))).appendTo(f)}function on_newdevice_selected(a){build_device_settings_modal(a);$("#device-modal").data("type",a);$("#device-modal").modal()}function create_add_device_page(){var g=sb_reset();var c=$.el;var e=c.tr();for(var d in source_type){var f=source_type[d];c.td({width:""+100/n_source_types+"%",style:"text-align:center"},c.a({href:"#",onclick:'on_newdevice_selected("'+d+'")'},c.img({src:f.iconfile}))).appendTo(e)}var a=c.div({"class":"well"},c.div({"class":"col1",id:"sync-pump-div"},c.h2("Add Device/App"),c.br(),"Which type or app type do you want to add?",c.br(),c.br(),c.div({"class":"well"},c.table({width:"100%"},e))));a.appendTo(g)}function delete_device(a){if(srclist.remove(a)){set_fb_group(fb.get_selected_group().name,"The device has been successfully removed.","Success!","alert alert-success")}else{set_fb_group(fb.get_selected_group().name,"Device removal failed.","Failure!","alert alert-error")}}var srclist={};var source_type=null;var n_source_types=0;srclist.getall=function(){var d=fb.get_selected_group();var e=null;var a=false;var c="/api/"+api_v_str+"/groups/"+d.id;url=prefixify(c,["sources"],[],true)[0];$.ajax({type:"GET",url:url,dataType:"json",success:function(f,g){e=f},error:function(f){a=true},data:{},async:false});if(a){return[]}source_type=e.source_types;n_source_types=0;for(var b in source_type){if(source_type.hasOwnProperty(b)){++n_source_types}}return e.sources};srclist.add=function(b,f){var e=fb.get_selected_group();var c=f;c.type=b;var g=null;var a=false;var d="/api/"+api_v_str+"/groups/"+e.id;url=prefixify(d,["sources"],[],true)[0];$.ajax({type:"POST",url:url,dataType:"json",success:function(h,i){g=h},error:function(h){a=true},data:c,async:false});if(a){return null}return g.id};srclist.remove=function(f){var d=fb.get_selected_group();var b=null;var e=null;var a=false;var c="/api/"+api_v_str+"/groups/"+d.id;url=prefixify(c,["sources/"+f],[],true)[0];$.ajax({type:"DELETE",url:url,dataType:"json",success:function(g,h){e=g},error:function(g){a=true},data:b,async:false});if(a){return false}return true};srclist.get=function(c){var b=this.getall();for(var a=0;a<b.length;a++){if(b[a].id==c){return b[a]}}return null};srclist.update=function(b,d){var c=this.getall();var a;if(desc){a=desc}else{a=source_type[c[b].type].desc}c[b].user=user;c[b].pass=pass;c[b].desc=a;localStorage.setItem("blipstate-"+fb.me.id,JSON.stringify(c))};function center_text(e,g,h,f,a,l,o,d){var c=h+a/2;var b=f+l/2;var i=e.append("text").attr("x",c).attr("y",b).attr("text-anchor","middle").attr("font-weight",d).attr("font-size",o).text(g);var n=parseInt(i.style("height"));i.attr("y",b+n/4);return i}function data_box_text(f,q,o,a,p){var i=f.append("g");var e=i.append("text").attr("id",a+p).attr("x",q).attr("y",o).attr("text-anchor","middle").attr("font-weight","bold").attr("font-size","180%").attr("fill","#444").attr("stroke","none").attr("opacity",0.4).text("256");var h=i.append("text").attr("x",q).attr("y",o).attr("text-anchor","middle").attr("font-weight","bold").attr("font-size","90%").attr("fill","#444").attr("stroke","none").attr("opacity",0.8).text(p);var b=parseInt(e.style("height"));var l=parseInt(e.style("width"));var r=parseInt(h.style("height"));var c=parseInt(h.style("width"));var d=b+1.5*r;var n=Math.max(l,c);e.attr("x",q+n/2);e.attr("y",o+b);h.attr("x",q+n/2);h.attr("y",o+b+r);if(0){i.append("rect").attr("x",q).attr("y",o).attr("width",n).attr("height",d).attr("fill","none").attr("stroke","black")}return{box:i,width:n,height:d}}function summary_data_box(g,a,q,n,b,e){var o=g.append("rect").attr("x",q).attr("y",n).attr("width",b).attr("height",100).attr("fill",e).attr("opacity",0.75);var i=data_box_text(g,q,n,a,"low");var h=data_box_text(g,q,n,a,"average");var d=data_box_text(g,q,n,a,"high");var l=Math.max(i.width,h.width,d.width);var f=Math.max(i.height,h.height,d.height);var c=b-3*l;if(c<0){log("summary box too narrow");return}var p=c/4;i.box.attr("transform",fmt_translate(p,0));h.box.attr("transform",fmt_translate(2*p+l,0));d.box.attr("transform",fmt_translate(3*p+2*l,0));o.attr("height",f);return f}function label_rect(e,h,i,g,a,p,c,d){var f=e.append("rect").attr("x",i).attr("y",g).attr("width",a).attr("height",10).attr("fill",c).attr("opacity",0.75);var n=e.append("text").attr("x",i+a/2).attr("y",g).attr("text-anchor","middle").attr("font-weight",d).attr("font-size",p).attr("opacity",0.8).attr("fill","#444").attr("streok","none").text(h);var b=parseInt(n.style("width"));var o=parseInt(n.style("height"));log(b+" x "+o);var l=o*2;f.attr("height",l);n.attr("y",g+1.25*o);return l}function build_mini_scale(l,i,c,o,n,d){var g=daterange.edate;var e=d3.time.day.offset(g,-90);var b=10;var a=d3.scale.linear().domain([e,g]).range([l+b,l+c-b]);var h={min:n,max:d};var f=d3.scale.linear().domain([h.min,h.max]).range([i+o*0.85,i+o*0.15]);return{xscale:a,yscale:f,xrange:{min:e,max:g},yrange:h}}function map_ts_to_array(a){ts_out=[];for(k in a){ts_out[midnight(a[k].x)]=a[k]}return ts_out}var all_graphs;function draw_mini_graph(u,o,n,z,t,A,E,l,F,i,c,w){var C=E.xrange.min;var f=E.xrange.max;var e=u.append("rect").attr("x",o).attr("y",n).attr("width",z).attr("height",t).attr("fill",A).attr("opacity",0.75);for(k in l){var b=l[k];u.append("svg:line").attr("x1",E.xscale(C)).attr("y1",E.yscale(b)).attr("x2",E.xscale(f)).attr("y2",E.yscale(b)).attr("opacity",0.6).attr("stroke-dasharray","3,1").attr("stroke","#555");u.append("svg:text").attr("x",E.xscale(C)).attr("y",E.yscale(b)).attr("dy","-0.4em").attr("opacity",0.8).attr("fill","#333").attr("stroke","none").attr("font-size","75%").text(b)}var q=u.append("svg:text").attr("x",E.xscale(f)).attr("y",E.yscale(E.yrange.max)).attr("fill","#444").attr("stroke","none").attr("font-size","90%").attr("text-anchor","end").text(F);var p=parseInt(q.style("height"));var h=first_of_months_between(C,f);for(k in h){var D=h[k];var g=month_of_year[D.getMonth()];u.append("svg:text").attr("x",E.xscale(D)).attr("y",E.yscale(E.yrange.min)).attr("dy","1.5em").attr("fill","#333").attr("stroke","none").attr("font-size","75%").attr("text-anchor","middle").text(g)}i(u);var B=u.append("svg:line").attr("class","mini-highlighter").attr("x1",E.xscale(C)).attr("y1",E.yscale(l[0])).attr("x2",E.xscale(C)).attr("y2",E.yscale(l[l.length-1])).attr("opacity",0.8).attr("stroke-dasharray","3,1").attr("stroke-width","1.5px").attr("stroke","black").attr("visibility","hidden");var a=u.append("svg:circle").attr("class","mini-highlighter").attr("cx",E.xscale(C)).attr("cy",E.yscale(E.yrange.min)).attr("r",3).attr("opacity",0.8).attr("stroke","black").attr("fill","none").attr("visibility","hidden");log("X");var r=u.append("rect").attr("class","top-highlighter").attr("x",o).attr("y",n).attr("width",z).attr("height",t).attr("opacity",0);all_graphs.push(r);r.update_highlighter=function(G){B.attr("visibility","visible");var d=E.xscale(G);B.attr("x1",d);B.attr("x2",d);a.attr("cx",d);var H=c[midnight(G)];var I=H.y;if(I==undefined){a.attr("visibility","hidden")}else{a.attr("visibility","visible");a.attr("cy",E.yscale(I))}d3.select("#"+w+"average").text(Math.round(H.y));d3.select("#"+w+"high").text(Math.round(H.max));d3.select("#"+w+"low").text(Math.round(H.min))};r.on("dblclick",function(K,H){log("DOUBLE");var G=d3.svg.mouse(this);var J=G[0];var y=E.xscale.invert(J);var I=new Date();I.setTime(y);log(I);build_dashboard();view_set_date(I);dbd.click_to_detailed(noon(I))});r.on("mouseout",function(y,x){e.attr("stroke","none");d3.selectAll(".mini-highlighter").attr("visibility","hidden")});r.on("mousemove",function(M,J){e.attr("stroke","black");var H=d3.svg.mouse(this);var L=H[0];var G=E.xscale.invert(L);var K=new Date();K.setTime(G);var I;for(I in all_graphs){all_graphs[I].update_highlighter(K)}return;d3.selectAll(".top-highlighter").each(function(Q,P){log(K);var O=E.xscale(K);B.attr("x1",O);B.attr("x2",O);a.attr("cx",O);var R=c[midnight(K)].y;if(R==undefined){a.attr("visibility","hidden")}else{a.attr("visibility","visible");a.attr("cy",E.yscale(R))}});return;var G=E.xscale(K);B.attr("x1",G);B.attr("x2",G);a.attr("cx",G);var N=c[midnight(K)].y;if(N==undefined){a.attr("visibility","hidden")}else{a.attr("visibility","visible");a.attr("cy",E.yscale(N))}})}function summary_box(e,I,H,a,M,A,P){var B=label_rect(e,M,I,H,a,"135%",A,"bold");var o=73;var K=2;var z=summary_data_box(e,M,I,H+B+K,a,A);var w=150;var L=H+B+z+2*K;e.append("rect").attr("x",I).attr("y",H+B+z+w+3*K).attr("width",a).attr("height",300).attr("fill",A).attr("opacity",0.75);if(M=="Sugar"){var h=40;var J=270;var E=build_mini_scale(I,L,a,w,h,J);var O=telemetry.mean_BG(E.xrange.min,E.xrange.max);var c=d3.svg.line().x(function(x){return E.xscale(x.x)}).y(function(x){return E.yscale(x.y)}).interpolate("linear");var D=[50,100,150,200,250];var d=function(x){x.append("svg:path").attr("class","bg_summary").attr("stroke","darkgreen").attr("fill","none").attr("opacity",0.8).attr("d",c(O))};var b=map_ts_to_array(O);draw_mini_graph(e,I,L,a,w,A,E,D,"sugar trend",d,b,M);var q=b[daterange.edate];d3.select("#Sugaraverage").text(Math.round(q.y));d3.select("#Sugarhigh").text(Math.round(q.max));d3.select("#Sugarlow").text(Math.round(q.min))}if(M=="Carbs"){var Q=0;var u=450;var E=build_mini_scale(I,L,a,w,Q,u);var O=telemetry.carb_consumption(E.xrange.min,E.xrange.max);var l=d3.svg.area().x(function(x){return E.xscale(x.x)}).y0(function(x){return E.yscale(0)}).y1(function(x){return E.yscale(x.y)}).interpolate("step-after");var d=function(x){x.append("svg:path").attr("class","carb_summary").attr("stroke","none").attr("fill","red").attr("opacity",0.4).attr("d",l(O))};var b=map_ts_to_array(O);var G=[0,100,200,300,400];draw_mini_graph(e,I,L,a,w,A,E,G,"carb trend",d,b,M)}if(M=="Insulin"){var f=0;var F=65;var E=build_mini_scale(I,L,a,w,f,F);var t=E.xrange.min;var i=E.xrange.max;var n=telemetry.basal_usage(t,i);var g=telemetry.bolus_usage(t,i);if(n.length!=g.length){log("basal and bolus time series need to match");return}var O=[];var N;for(N=0;N<g.length;N++){g[N].y0=n[N].y;O[N]={x:g[N].x,y:(g[N].y+n[N].y)}}var p=d3.svg.area().x(function(x){return E.xscale(x.x)}).y0(function(x){return E.yscale(0)}).y1(function(x){return E.yscale(x.y)}).interpolate("step-after");var r=d3.svg.area().x(function(x){return E.xscale(x.x)}).y0(function(x){return E.yscale(x.y0)}).y1(function(x){return E.yscale(x.y0+x.y)}).interpolate("step-after");var d=function(x){x.append("svg:path").attr("class","insulin_summary").attr("stroke","none").attr("fill","darkblue").attr("opacity",0.4).attr("d",p(n));x.append("svg:path").attr("class","insulin_summary").attr("stroke","none").attr("fill","blue").attr("opacity",0.4).attr("d",r(g))};var C=[0,20,40,60];draw_mini_graph(e,I,L,a,w,A,E,C,"insulin trend",d,map_ts_to_array(O),M)}}function draw_summary(){var a=d3.select("#d3-summary").append("svg").attr("width",920).attr("height",570);a.append("rect").attr("x",2).attr("y",2).attr("width",916).attr("height",550).attr("fill","#f5f5f5");a.append("text").attr("x",20).attr("y",32).attr("font-weight","bold").attr("font-size","165%").text("Electra's Summary (work in progress)");var c=20;var b=(920-4*c)/3;var d=65;all_graphs=[];summary_box(a,c,d,b,"Sugar","lightgreen",{avg:176,low:66,high:412});summary_box(a,2*c+b,d,b,"Insulin","lightblue",{avg:"32u",low:"28u",high:"45u"});summary_box(a,3*c+2*b,d,b,"Carbs","lightpink",{avg:"84g",low:"55g",high:"155g"})}function draw_sugar_graph(q,n,l,t,p,u,B,i,C,c,r){var z=B.xrange.min;var f=B.xrange.max;var e=q.append("rect").attr("x",n).attr("y",l).attr("width",t).attr("height",p).attr("fill","lightgray").attr("opacity",0.75).attr("stroke","black");for(k in i){var b=i[k];q.append("svg:line").attr("x1",B.xscale(z)).attr("y1",B.yscale(b)).attr("x2",B.xscale(f)).attr("y2",B.yscale(b)).attr("opacity",0.6).attr("stroke-dasharray","3,1").attr("stroke","#555");q.append("svg:text").attr("x",B.xscale(z)).attr("y",B.yscale(b)).attr("dy","-0.4em").attr("opacity",0.8).attr("fill","#333").attr("stroke","none").attr("font-size","75%").text(b)}var h=first_of_months_between(z,f);for(k in h){var A=h[k];var g=month_of_year[A.getMonth()];q.append("svg:text").attr("x",B.xscale(A)).attr("y",B.yscale(B.yrange.min)).attr("dy","1.5em").attr("fill","#333").attr("stroke","none").attr("font-size","135%").attr("font-weight","bold").attr("text-anchor","middle").text(g)}var w=q.append("svg:line").attr("class","mini-highlighter").attr("x1",B.xscale(z)).attr("y1",B.yscale(i[0])).attr("x2",B.xscale(z)).attr("y2",B.yscale(i[i.length-1])).attr("opacity",0.8).attr("stroke-dasharray","3,1").attr("stroke-width","1.5px").attr("stroke","black").attr("visibility","hidden");var a=q.append("svg:circle").attr("class","mini-highlighter").attr("cx",B.xscale(z)).attr("cy",B.yscale(B.yrange.min)).attr("r",3).attr("opacity",0.8).attr("stroke","black").attr("fill","none").attr("visibility","hidden");var o=q.append("rect").attr("class","top-highlighter").attr("x",n).attr("y",l).attr("width",t).attr("height",p).attr("opacity",0);o.update_highlighter=function(D){return;w.attr("visibility","visible");var d=B.xscale(D);w.attr("x1",d);w.attr("x2",d);a.attr("cx",d);var E=c[midnight(D)];var F=E.y;if(F==undefined){a.attr("visibility","hidden")}else{a.attr("visibility","visible");a.attr("cy",B.yscale(F))}};o.on("dblclick",function(H,E){log("DOUBLE");var D=d3.svg.mouse(this);var G=D[0];var y=B.xscale.invert(G);var F=new Date();F.setTime(y);log(F);build_dashboard();view_set_date(F);dbd.click_to_detailed(noon(F))});o.on("mouseout",function(y,x){d3.selectAll(".mini-highlighter").attr("visibility","hidden")});o.on("mousemove",function(J,G){return;var E=d3.svg.mouse(this);var I=E[0];var D=B.xscale.invert(I);var H=new Date();H.setTime(D);var F;for(F in all_graphs){all_graphs[F].update_highlighter(H)}return;d3.selectAll(".top-highlighter").each(function(N,M){log(H);var L=B.xscale(H);w.attr("x1",L);w.attr("x2",L);a.attr("cx",L);var O=c[midnight(H)].y;if(O==undefined){a.attr("visibility","hidden")}else{a.attr("visibility","visible");a.attr("cy",B.yscale(O))}});return;var D=B.xscale(H);w.attr("x1",D);w.attr("x2",D);a.attr("cx",D);var K=c[midnight(H)].y;if(K==undefined){a.attr("visibility","hidden")}else{a.attr("visibility","visible");a.attr("cy",B.yscale(K))}})}function build_sugar_scale(l,i,c,o,n,d){var g=daterange.edate;var e=d3.time.day.offset(g,-90);var b=10;var a=d3.scale.linear().domain([e,g]).range([l+b,l+c-b]);var h={min:n,max:d};var f=d3.scale.linear().domain([h.min,h.max]).range([i+o*0.85,i+o*0.15]);return{xscale:a,yscale:f,xrange:{min:e,max:g},yrange:h}}function sugar_graph(i,e,d,o,h){var l=40;var n=350;var w=build_sugar_scale(e,d,o,h,l,n);var b=telemetry.selectBGs(w.xrange.min,w.xrange.max);var a=telemetry.mean_BG(w.xrange.min,w.xrange.max);var p=telemetry.dev_up_BG(w.xrange.min,w.xrange.max);var q=telemetry.dev_down_BG(w.xrange.min,w.xrange.max);var u=d3.svg.line().x(function(x){return w.xscale(x.x)}).y(function(x){return w.yscale(x.y)}).interpolate("linear");var t=[50,100,150,200,250,300];var c=map_ts_to_array(a);log("TSA");log(c);draw_sugar_graph(i,e,d,o,h,"gray",w,t,"sugar trend",c,"Sugar");i.selectAll(".aBGs").data(b).enter().append("circle").attr("cx",function(x){return w.xscale(x.x)}).attr("cy",function(x){return w.yscale(Math.min(x.y,n))}).attr("r",4).attr("opacity","0.25").attr("fill",function(y,x){return bg_to_simple_color2(y.y)});if(true){var f=[];var r;for(r=0;r<p.length;++r){f.push({x:p[r].x,y0:q[r].y,y1:p[r].y})}var g=d3.svg.area().x(function(x){return w.xscale(x.x)}).y0(function(x){return(w.yscale(x.y0))}).y1(function(x){return(w.yscale(x.y1))}).interpolate("linear");i.append("svg:path").attr("class","sugar_dev").attr("fill","lightblue").attr("opacity","0.5").attr("d",g(f)).on("mouseover",function(y,x){d3.select(this).attr("opacity","0.75")}).on("mouseout",function(y,x){d3.select(this).attr("opacity","0.5")});i.append("svg:path").attr("class","bg_analysis").attr("stroke","darkblue").attr("stroke-width","3px").attr("stroke-dasharray","5,2").attr("fill","none").attr("opacity",0.75).attr("d",u(a));i.append("svg:path").attr("class","bg_analysis").attr("stroke","darkgray").attr("stroke-width","3px").attr("fill","none").attr("opacity",0.8).attr("d",u(p));i.append("svg:path").attr("class","bg_analysis").attr("stroke","darkgray").attr("stroke-width","3px").attr("fill","none").attr("opacity",0.8).attr("d",u(q))}}function draw_sugar_trend(){var d=2;var a=40;var c=400;var b=d3.select("#sugar-trend").append("svg").attr("width",920).attr("height",d*c+4);b.append("rect").attr("x",2).attr("y",2).attr("width",916).attr("height",d*c).attr("fill","#f5f5f5");if(false){b.append("text").attr("x",15).attr("y",20).attr("font-weight","bold").attr("font-size","165%").text("sugar trend")}sugar_graph(b,2,a,916,c)}function draw_insulin_graph(q,n,l,t,p,u,B,i,C,c,r){var z=B.xrange.min;var f=B.xrange.max;var e=q.append("rect").attr("x",n).attr("y",l).attr("width",t).attr("height",p).attr("fill","lightgray").attr("opacity",0.75).attr("stroke","black");for(k in i){var b=i[k];q.append("svg:line").attr("x1",B.xscale(z)).attr("y1",B.yscale(b)).attr("x2",B.xscale(f)).attr("y2",B.yscale(b)).attr("opacity",0.6).attr("stroke-dasharray","3,1").attr("stroke","#555");q.append("svg:text").attr("x",B.xscale(z)).attr("y",B.yscale(b)).attr("dy","-0.4em").attr("opacity",0.8).attr("fill","#333").attr("stroke","none").attr("font-size","75%").text(b)}var h=first_of_months_between(z,f);for(k in h){var A=h[k];var g=month_of_year[A.getMonth()];q.append("svg:text").attr("x",B.xscale(A)).attr("y",B.yscale(B.yrange.min)).attr("dy","1.5em").attr("fill","#333").attr("stroke","none").attr("font-size","135%").attr("font-weight","bold").attr("text-anchor","middle").text(g)}var w=q.append("svg:line").attr("class","mini-highlighter").attr("x1",B.xscale(z)).attr("y1",B.yscale(i[0])).attr("x2",B.xscale(z)).attr("y2",B.yscale(i[i.length-1])).attr("opacity",0.8).attr("stroke-dasharray","3,1").attr("stroke-width","1.5px").attr("stroke","black").attr("visibility","hidden");var a=q.append("svg:circle").attr("class","mini-highlighter").attr("cx",B.xscale(z)).attr("cy",B.yscale(B.yrange.min)).attr("r",3).attr("opacity",0.8).attr("stroke","black").attr("fill","none").attr("visibility","hidden");var o=q.append("rect").attr("class","top-highlighter").attr("x",n).attr("y",l).attr("width",t).attr("height",p).attr("opacity",0);o.update_highlighter=function(D){return;w.attr("visibility","visible");var d=B.xscale(D);w.attr("x1",d);w.attr("x2",d);a.attr("cx",d);var E=xxx[midnight(D)];var F=E.y;if(F==undefined){a.attr("visibility","hidden")}else{a.attr("visibility","visible");a.attr("cy",B.yscale(F))}};o.on("dblclick",function(H,E){log("DOUBLE");var D=d3.svg.mouse(this);var G=D[0];var y=B.xscale.invert(G);var F=new Date();F.setTime(y);log(F);build_dashboard();view_set_date(F);dbd.click_to_detailed(noon(F))});o.on("mouseout",function(y,x){d3.selectAll(".mini-highlighter").attr("visibility","hidden")});o.on("mousemove",function(J,G){return;var E=d3.svg.mouse(this);var I=E[0];var D=B.xscale.invert(I);var H=new Date();H.setTime(D);var F;for(F in all_graphs){all_graphs[F].update_highlighter(H)}return;d3.selectAll(".top-highlighter").each(function(N,M){log(H);var L=B.xscale(H);w.attr("x1",L);w.attr("x2",L);a.attr("cx",L);var O=xxx[midnight(H)].y;if(O==undefined){a.attr("visibility","hidden")}else{a.attr("visibility","visible");a.attr("cy",B.yscale(O))}});return;var D=B.xscale(H);w.attr("x1",D);w.attr("x2",D);a.attr("cx",D);var K=xxx[midnight(H)].y;if(K==undefined){a.attr("visibility","hidden")}else{a.attr("visibility","visible");a.attr("cy",B.yscale(K))}})}function ts_mean(c){var a;var d=c.length;var b=0;for(a=0;a<d;a+=1){b+=c[a].y}return b/d}function insulin_trend_ts(b,d,a){var g=b;var e=[];while(g<=d){var h=add_days(g,-1*a);var f=telemetry.basal_usage(h,g);var c=telemetry.bolus_usage(h,g);var i={x:g,basal:ts_mean(f),bolus:ts_mean(c)};e.push(i);g=add_days(g,1)}return e}function insulin_graph(h,r,q,b,t){var c=3;var f=0;var o=50;var e=build_sugar_scale(r,q,b,t,f,o);var n=insulin_trend_ts(e.xrange.min,e.xrange.max,c);var g=d3.svg.line().x(function(u){return e.xscale(u.x)}).y(function(u){return e.yscale(u.basal)}).interpolate("linear");var p=d3.svg.line().x(function(u){return e.xscale(u.x)}).y(function(u){return e.yscale(u.basal+u.bolus)}).interpolate("linear");var i=[0,10,20,30,40,50];log(n);log(e);draw_insulin_graph(h,r,q,b,t,"gray",e,i,"insulin trend",n,"Insulin");if(true){var d=d3.svg.area().x(function(u){return e.xscale(u.x)}).y0(function(u){return(e.yscale(0))}).y1(function(u){return(e.yscale(u.basal))}).interpolate("linear");var a=d3.rgb("lightblue").darker();h.append("svg:path").attr("class","basal_area").attr("fill",a).attr("opacity","0.75").attr("d",d(n));var l=d3.svg.area().x(function(u){return e.xscale(u.x)}).y0(function(u){return(e.yscale(u.basal))}).y1(function(u){return(e.yscale(u.basal+u.bolus))}).interpolate("linear");h.append("svg:path").attr("class","bolus_area").attr("fill","lightblue").attr("opacity","0.75").attr("d",l(n));h.append("svg:path").attr("class","insulin_analysis").attr("stroke","darkblue").attr("stroke-width","2px").attr("stroke-dasharray","5,2").attr("fill","none").attr("opacity",0.75).attr("d",g(n));h.append("svg:path").attr("class","insulin_analysis").attr("stroke","darkblue").attr("stroke-width","2px").attr("stroke-dasharray","5,2").attr("fill","none").attr("opacity",0.75).attr("d",p(n));return;h.append("svg:path").attr("class","bg_analysis").attr("stroke","darkgray").attr("stroke-width","3px").attr("fill","none").attr("opacity",0.8).attr("d",line_func(ts_up));h.append("svg:path").attr("class","bg_analysis").attr("stroke","darkgray").attr("stroke-width","3px").attr("fill","none").attr("opacity",0.8).attr("d",line_func(ts_down))}}function draw_insulin_trend(){var d=2;var a=40;var c=400;var b=d3.select("#insulin-trend").append("svg").attr("width",920).attr("height",d*c+4);insulin_graph(b,2,a,916,c)}telemetry={};telemetry.loaded=false;telemetry.note_date=function(a){if(this.minDate==undefined){this.minDate=this.maxDate=a}else{if(a.getTime()<this.minDate.getTime()){this.minDate=midnight(a)}else{if(a.getTime()>this.maxDate.getTime()){this.maxDate=a}}}};telemetry.add_pump_data=function(f){log(f);var d;for(d in f){var e=f[d];if(e==null){log("ADD-DATA: null data");log(f);continue}var c=new Date(e.time);this.note_date(c);var b=midnight(c);var a=this.pump_data[b];if(a==undefined){a={BG:[],carbs:[],basal:[],bolus:[],cBG:[],events:[],settings:[],activity:[],food:[],note:[],glucose:[],rk:[],ad:[]};this.pump_data[b]=a}if(e.mode!=undefined&&e.mode!=""&&e.mode!="still"&&e.mode!="drive"){a.activity.push({x:c,y:e.mode})}else{if(e.glucose!=undefined&&e.glucose!=""){a.glucose.push({x:c,glucose:e.glucose})}else{if(e.uri!=undefined&&e.type!=undefined){a.rk.push({x:c,y:e})}else{if(e.carbCount!=undefined&&e.carbCount!=""){a.food.push({x:c,y:e})}else{if(e.note!=undefined&&e.note!=""){a.note.push({x:c,y:e.note})}else{if(e["post-time"]!=undefined&&e.delivered!=undefined){a.ad.push({x:c,y:{calculated:e.calculated,bolus:e.delivered}})}else{if(e.bg!=undefined&&e.bg!=""){a.BG.push({x:c,y:e.bg})}else{if(e.carbs!=undefined&&e.carbs!=""){a.carbs.push({x:c,y:e.carbs})}else{if(e.basal!=undefined&&e.basal!=""){a.basal.push({x:c,y:e.basal})}else{if(e.bolus!=undefined&&e.bolus!=""){a.bolus.push({x:c,y:e.bolus})}else{if(e.settings!=undefined){a.settings.push({x:c,y:e.settings})}else{if(e.cbg!=undefined&&e.cbg!=""){a.cBG.push({x:c,y:e.cbg})}else{if(e.event!=undefined&&e.event!=""){a.events.push({x:c,y:e.event})}}}}}}}}}}}}}}};telemetry.latest_basal_program=function(){var e=midnight(telemetry.minDate);var a=midnight(telemetry.maxDate);while(a>=e){var d=this.pump_data[a];if(d!=undefined&&d.settings!=undefined){var c=d.settings;var b=c[0];if(b!==undefined){return b.y["basal-programs"][0]}}a=add_days(a,-1)}return undefined};telemetry.find_next_basal_program=function(a,d){while(a<d){var e=this.pump_data[a];if(e!=undefined&&e.settings!=undefined){var c=e.settings;var b=c[0];return{x:b.x,y:b.y["basal-programs"][0]}}a=add_days(a,1)}return undefined};telemetry.fillout_basal_programs=function(){var c=midnight(telemetry.minDate);var a=midnight(telemetry.maxDate);var b=this.find_next_basal_program(c);var d=this.find_next_basal_program(add_days(midnight(b.x),1));while(c<=a){this.pump_data[c].basal_program=this.get_basal_program(s);c=add_days(c,1)}};function add_days(a,b){return d3.time.day.offset(a,b)}function date_range(a,c){var b=d3.time.day.offset(midnight(c),1);return d3.time.days(midnight(a),b)}telemetry.selectBGs_orig=function(a,c){var e=date_range(a,c);var d=[];for(var b=0;b<e.length;++b){dd=this.pump_data[e[b]];if(dd!=undefined){for(k in dd.BG){d.push(dd.BG[k])}}}return d};telemetry.selectBGs_omh=function(a,f){var e=this.selectBGs_orig(a,f);var b=this.selectGlucose(a,f);for(var d=0;d<b.length;++d){b[d].y=b[d].glucose}var g=e.concat(b);var c=_.sortBy(g,function(h){return h.x.getTime()});return c};telemetry.selectBGs=telemetry.selectBGs_omh;telemetry.selectGlucose=function(a,c){var e=date_range(a,c);var d=[];for(var b=0;b<e.length;++b){dd=this.pump_data[e[b]];if(dd!=undefined){for(k in dd.glucose){d.push(dd.glucose[k])}}}return d};telemetry.selectCarbs=function(a,c){var e=date_range(a,c);var d=[];for(var b=0;b<e.length;++b){dd=this.pump_data[e[b]];if(dd!=undefined){for(k in dd.carbs){d.push(dd.carbs[k])}}}return d};telemetry.selectBasal=function(a,c){var e=date_range(a,c);var d=[];for(var b=0;b<e.length;++b){dd=this.pump_data[e[b]];if(dd!=undefined){for(k in dd.basal){d.push(dd.basal[k])}}}return d};telemetry.stretch_to_day=function(f){var b=[];if(f.length>0){var e=f[0].x;var g=midnight(e);if(g.getTime()!=e.getTime()){b.push({x:midnight(f[0].x),y:f[0].y})}var a;for(a=0;a<f.length;a+=1){b.push(f[a])}var d=f[f.length-1].x;var c=add_days(midnight(d),1);if(c.getTime!=d.getTime()){b.push({x:c,y:f[f.length-1].y})}}return b};telemetry.selectBasalByDay=function(a,d){var f=date_range(a,d);var e=[];for(var c=0;c<f.length;++c){var b=f[c];var g=this.selectBasal(b,b);e.push(this.stretch_to_day(g))}return e};telemetry.selectBolus=function(a,c){var f=date_range(a,c);var e=[];for(var b=0;b<f.length;++b){dd=this.pump_data[f[b]];if(dd!=undefined){for(k in dd.bolus){e.push(dd.bolus[k])}}}var d=this.selectAdherence(a,c);this.mixin_adherence(e,d);return e};telemetry.selectAdherence=function(a,c){var e=date_range(a,c);var d=[];for(var b=0;b<e.length;++b){dd=this.pump_data[e[b]];if(dd!=undefined){for(k in dd.ad){d.push(dd.ad[k])}}}return d};telemetry.find_adherence=function(e,g){var f;for(f=0;f<g.length;f+=1){var c=g[f];if(e.x.getTime()==c.x.getTime()&&parseFloat(e.y.bolus)===parseFloat(c.y)){var h=format_time_insulin_data(c);log("adherence: "+e.y.calculated+" "+h);return f}}return undefined};telemetry.mixin_adherence=function(f,e){var c;for(c=0;c<e.length;c+=1){var b=e[c];var d=this.find_adherence(b,f);if(d!=undefined){f[d].calculated=b.y.calculated}}};telemetry.selectCgm=function(a,c){var e=date_range(a,c);var d=[];for(var b=0;b<e.length;++b){dd=this.pump_data[e[b]];if(dd!=undefined){for(k in dd.cBG){d.push(dd.cBG[k])}}}return d};telemetry.normalizeEvents=function(c,a){var b=undefined;for(k in a){var d=a[k];if(b!=undefined&&d.x.getTime()==b.x.getTime()){b.y+=","+d.y}else{c.push(d);b=d}}};telemetry.selectEvents=function(a,c){var e=date_range(a,c);var d=[];for(var b=0;b<e.length;++b){dd=this.pump_data[e[b]];if(dd!=undefined){telemetry.normalizeEvents(d,dd.events)}}return d};telemetry.selectActivity=function(a,c){var e=date_range(a,c);var d=[];for(var b=0;b<e.length;++b){dd=this.pump_data[e[b]];if(dd!=undefined){for(k in dd.activity){d.push(dd.activity[k])}}}return d};telemetry.selectRk=function(a,c){var e=date_range(a,c);var d=[];for(var b=0;b<e.length;++b){dd=this.pump_data[e[b]];if(dd!=undefined){for(k in dd.rk){d.push(dd.rk[k])}}}return d};telemetry.selectNotes=function(a,c){var e=date_range(a,c);var d=[];for(var b=0;b<e.length;++b){dd=this.pump_data[e[b]];if(dd!=undefined){for(k in dd.note){d.push(dd.note[k])}}}return d};telemetry.selectFood=function(a,c){var e=date_range(a,c);var d=[];for(var b=0;b<e.length;++b){dd=this.pump_data[e[b]];if(dd!=undefined){for(k in dd.food){d.push(dd.food[k])}}}return d};function coalesce(h){var e=[];var c=0;var g=5*60*1000;while(c<h.length){var a=c;var d=a;var b=h[c].x;var f=b.getTime()+5*60*1000;var i=[h[c]];while((d+1)<h.length&&h[d+1].x.getTime()<f){d=d+1;i.push(h[d])}e.push({x:b,y:i});c=d+1}return e}telemetry.selectOMHNotes=function(a,d){var f=this.selectFood(a,d);var c=this.selectNotes(a,d);var e=f.concat(c);var b=_.sortBy(e,function(g){return g.x.getTime()});return coalesce(b)};telemetry.process_file=function(b,a){log("LOADING: "+b);if(a!=null){this.add_pump_data(a)}this.nread+=1;if(this.nread>=this.nfiles){this.loaded=true;this.callback()}};telemetry.load_init=function(a){this.loaded=false;this.minDate=undefined;this.maxDate=undefined;this.pump_data={};this.callback=a};telemetry.async_load=function(b){var a=this;log("ASYNC-LOAD: "+b);d3.json(b,function(c){a.process_file(b,c)})};telemetry.load=function(b,c){this.load_init(c);this.nfiles=b.length;this.nread=0;var a;for(a in b){this.async_load(b[a])}};telemetry.find_smallest_causal_pt=function(a,c){var b;for(b in c){if(c[b].x>=a){return b}}return -1};telemetry.find_isolated_highs=function(b,d,o){ts=[];var e;for(e in b){var f=b[e].y;if(f<180){continue}var h=b[e].x;var i=this.find_smallest_causal_pt(h,o);if(i<0){continue}var g=o[i].x;var a=d3.time.minute.offset(h,15);if(g>a){continue}var n=d3.time.minute.offset(h,-15);var l=this.find_smallest_causal_pt(n,d);if(l>=0){var c=d[l].x;if(c>n&&c<a){continue}}ts.push([e,i])}return ts};telemetry.find_covered_carbs=function(a,c,e){ts=[];var b;var g;for(b in c){var f=c[b].x;var d=this.find_smallest_causal_pt(f,e);if(f.getTime()==e[d].x.getTime()&&e[d].y>0){ts.push([b,d])}}return ts};var electra_program_jun2012=[{x:0,y:0.7},{x:2,y:0.65},{x:4,y:0.675},{x:5,y:0.75},{x:6,y:0.8},{x:9,y:0.7},{x:10,y:0.65},{x:13,y:0.725},{x:15,y:0.8},{x:17,y:0.75},{x:20,y:0.8},{x:23,y:0.725}];telemetry.basal_stats=function(d){var c={min:100,max:0};var b;for(b=0;b<d.length;++b){var a=parseFloat(d[b].y);if(a>0){if(a<c.min){c.min=a}if(a>c.max){c.max=a}}}return c};function basal_by_hour(a,c){var d=get_hour(a);var b;for(b=1;b<c.length;b+=1){if(d<c[b].x){return c[b-1].y}}return c[c.length-1].y}function basal_prev_by_hour(a,c){var d=get_hour(a);var b;for(b=0;b<c.length;b+=1){if(c[b].x>=d){if(b==0){return c[0].y}return c[b-1].y}}return c[c.length-1].y}function find_next_deviation(e,d,b){var f=d.length;while(e<f){var c=d[e].y;var a=basal_by_hour(d[e].x,b);if(c!=a){return e}e+=1}return -1}function find_next_conformance(e,d,b){var f=d.length;while(e<f){var c=d[e].y;var a=basal_by_hour(d[e].x,b);if(c==a){return e}e+=1}return -1}telemetry.find_temp_basals=function(f,b){var o=[];var a=b.length;var c=0;while(1){var p=find_next_deviation(c,b,f);if(p<0){return o}var d=find_next_conformance(p,b,f);var h=d;if(h<0){h=b.length-1}var e;var q=[];for(e=p;e<=h;e+=1){var l=b[e].x;var g=basal_by_hour(l,f);q.push({actual:b[e],program:g})}o.push(q);if(d<0){return o}c=h}return o};telemetry.mean_BG_2wk=function(c){var d=0;var f=0;var b=1000;var e=0;c=midnight(c);for(k=0;k<14;++k){var a=d3.time.day.offset(c,-k);dd=this.pump_data[a];if(dd!=undefined){for(j in dd.BG){bg=parseFloat(dd.BG[j].y);d+=bg;f+=1;if(bg>e){e=bg}if(bg<b){b=bg}}}}if(f==0){return undefined}return{mean:(d/f),max:e,min:b}};telemetry.mean_dev_BG_2wk=function(d,b){var a={s:0,n:0};var e={s:0,n:0};d=midnight(d);for(k=0;k<14;++k){var c=d3.time.day.offset(d,-k);dd=this.pump_data[c];if(dd!=undefined){for(j in dd.BG){bg=parseFloat(dd.BG[j].y);if(bg>b){a.s+=bg-b;a.n+=1}if(bg<b){e.s+=bg-b;e.n+=1}}}}if(a.n==0){return undefined}return{updev:(a.s/a.n),downdev:(e.s/e.n),mean:b}};telemetry.mean_BG=function(b,d){var e=[];var c=midnight(b);while(c<=d){var a=this.mean_BG_2wk(c);if(a!=undefined){e.push({x:c,y:a.mean,min:a.min,max:a.max})}c=d3.time.day.offset(c,1)}return e};telemetry.dev_up_BG=function(b,d){var e=[];var c=midnight(b);while(c<=d){var f=this.mean_BG_2wk(c);if(f!=undefined){var a=this.mean_dev_BG_2wk(c,f.mean);if(a!=undefined){e.push({x:c,y:(a.mean+a.updev)})}}c=d3.time.day.offset(c,1)}return e};telemetry.dev_down_BG=function(b,d){var e=[];var c=midnight(b);while(c<=d){var f=this.mean_BG_2wk(c);if(f!=undefined){var a=this.mean_dev_BG_2wk(c,f.mean);if(a!=undefined){e.push({x:c,y:(a.mean+a.downdev)})}}c=d3.time.day.offset(c,1)}return e};telemetry.carb_consumption=function(a,d){var g=[];var b=midnight(a);var c=20000;var f=0;while(b<=d){var e=0;dd=this.pump_data[b];if(dd!=undefined){for(j in dd.carbs){carbs=parseFloat(dd.carbs[j].y);e+=carbs;if(carbs>f){f=carbs}if(carbs<c){c=carbs}}}g.push({x:b,y:e});b=d3.time.day.offset(b,1)}return g};telemetry.bolus_usage=function(a,c){var e=[];var b=midnight(a);while(b<=c){var d=0;dd=this.pump_data[b];if(dd!=undefined){for(j in dd.bolus){d+=parseFloat(dd.bolus[j].y)}}e.push({x:b,y:d});b=d3.time.day.offset(b,1)}return e};telemetry.basal_usage=function(a,d){var i=[];var c=midnight(a);while(c<=d){var g=0;var f=0;var e=0;dd=this.pump_data[c];if(dd!=undefined){for(j in dd.basal){var b=get_hour(dd.basal[j].x);g+=(b-f)*e;f=b;e=dd.basal[j].y}}g+=(24-f)*e;i.push({x:c,y:g});c=d3.time.day.offset(c,1)}return i};telemetry.basal_bolus_mix=function(a,c){var h=telemetry.basal_usage(a,c);var f=telemetry.bolus_usage(a,c);if(h.length!=f.length){log("basal and bolus time series need to match");return}var e=[];var b;for(b=0;b<f.length;b++){var d=f[b].y+h[b].y;var g=h[b].y/d;f[b].y0=h[b].y;e[b]={x:f[b].x,y:g,s:d}}return e};function log(a){if(1){console.log(a)}return(a)}var day_of_week={0:"Sun",1:"Mon",2:"Tue",3:"Wed",4:"Thu",5:"Fri",6:"Sat"};var month_of_year={0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"};function day_postfix(a){if((a>=4&&a<=20)||(a>=24&&a<=30)){return"th"}m=a%10;if(m==1){return"st"}if(m==2){return"nd"}return"rd"}function friendly_date(b){var a=b.getDate();return day_of_week[b.getDay()]+"-"+a+day_postfix(a)}function weekday(b){var a=b.getDate();return day_of_week[b.getDay()]}function friendly_date2(a){return day_of_week[a.getDay()]+" "+month_of_year[a.getMonth()]+" "+a.getDate()}function friendly_date3(a){return(a.getMonth()+1)+"/"+a.getDate()+"/"+a.getFullYear()}function friendly_date4(a){return(a.getMonth()+1)+"/"+a.getDate()}function first_of_months_between(f,a){var c=[];var e=f.getMonth()+1;var b=f.getYear();var g=midnight(new Date(e+"/1/"+b));while(g<=a){if(g>=f){c.push(g)}g=d3.time.month.offset(g,1)}return c}function format_time(e){var c=e.getHours();var a=e.getMinutes();if(a<10){a="0"+a}var b;if(c==12){b="pm"}else{if(c>12){b="pm";c-=12}else{if(c==0){c=12}b="am"}}return c+":"+a+b}function format_time_bg_data(a){return Math.round(a.y)+" @ "+format_time(a.x)+" "+friendly_date(a.x)}function format_time_insulin_data(b){var a=parseFloat(b.y)+"u @ "+format_time(b.x);if(b.carb!=undefined){a+=" (for "+parseFloat(b.carb.y)+"g of carbs)"}if(b.calculated){a+=" [overrode "+parseFloat(b.calculated)+"u]"}return a}function format_time_ihigh_data(b,c){var d=110;var a=Math.round((b.y-d)/c.y);return"ISF "+a+" = ("+Math.round(b.y)+" - "+d+") / "+parseFloat(c.y)+"u"}function format_time_carb_cover(d,e){var c=d.y;var b=e.y;var a=c/b;if(a<10){a=Math.round(10*a)/10}else{a=Math.round(a)}return"I:C "+a}function format_time_basal_data(d,a){var b=d.x;var c=a.x;s=parseFloat(d.y)+"u/hr "+format_time(b)+" to "+format_time(c);return s}function format_time_carb_data(e){var b=Math.round(e.y)+"g @ "+format_time(e.x);if(e.carb_bolus!=0){var a=parseFloat(e.carb_bolus.y);var c=format_time(e.carb_bolus.x);b+=" (covered with "+a+"U)\n"}return b}function bg_to_class(a){if(a<80){return"low"}if(a<140){return"green"}if(a<180){return"yellow"}return"high";if(a<50){return"low-urgent"}if(a<60){return"low-attention"}if(a<70){return"low"}if(a<180){return"neutral"}if(a<250){return"high"}if(a<300){return"high-attention"}return"high-urgent"}function bg_to_radius(a){if(a<70){a=70}if(a>350){a=350}return 6+Math.sqrt((a-70)/550*70)}function midnight(a){return d3.time.day(a)}function noon(a){return d3.time.hour.offset(midnight(a),12)}function days_between(d,a){var c=midnight(a).getTime()-midnight(d).getTime();var b=c/(1000*24*3600);return b}function get_hour(b){var a=b.getTime()-midnight(b).getTime();return a/(1000*60*60)}function add_days(a,b){return d3.time.day.offset(a,b)}function add_minutes(a,b){return d3.time.minute.offset(a,b)}var daylight=[0,1,2,3,4,5,9,14,16,17,18,20,22,20,18,17,16,14,9,5,4,3,2,1];function hour_to_string(a){var b=Math.round(a)%24;if(b<=0){return"midnight"}if(b<12){return b+"am"}if(b>12){return(b-12)+"pm"}return"noon"}function hour_to_string2(a){var b=Math.round(a)%24;if(b<=0){return"12am"}if(b<12){return b+"am"}if(b>12){return(b-12)+"pm"}return"12pm"}function hour_to_color(c){var a=150;var b=20;weight=daylight[Math.floor(c)]/24;var d=Math.floor(weight*(a-b))+b;return d3.rgb(d,d,d)}function limit(c,a,b){if(c>b){return b}if(c<a){return a}return c}function fmt_translate(a,b){return"translate("+a+","+b+")"}function timeAgo(d){log(d);var b=new Date((d||"").replace(/-/g,"/").replace(/[TZ]/g," ")),c=(((new Date()).getTime()-b.getTime())/1000),a=Math.floor(c/86400);if(isNaN(a)||a<0||a>=31){return}return a==0&&(c<60&&"just now"||c<120&&"1 minute ago"||c<3600&&Math.floor(c/60)+" minutes ago"||c<7200&&"1 hour ago"||c<86400&&Math.floor(c/3600)+" hours ago")||a==1&&"Yesterday"||a<7&&a+" days ago"||a<31&&Math.ceil(a/7)+" weeks ago"}function uniform(d,c){return d+(c-d)*Math.random()}function sort_dates(e){var c=[];var b;for(b=0;b<e.length;++b){c.push(e[b].getTime())}c.sort().reverse();var a=[];for(b=0;b<e.length;++b){var f=new Date();f.setTime(c[b]);a.push(f)}return a}function basal_program_to_ts(f){var h=[];var c;for(c=0;c<f.length;++c){var a=f[c];var i=a.time.split(":");var d=parseInt(i[0]);var e=parseInt(i[1]);var g=parseInt(i[2]);var b=d+e/60+g/3600;h.push({x:b,y:a.value})}return h}function basal_program_to_pts(e,h,b){var d;var f=[];var c=h;while(c<=b){for(d=0;d<e.length;++d){var g=e[d];var a=add_minutes(c,60*g.x);f.push({x:a,y:g.y})}c=add_days(c,1)}return f}function generic_modal(e,d){var c=$("#spa_root").get(0);var a=$.el;d3.select("#generic-modal").remove();a.div({id:"generic-modal","class":"modal hide fade",tabindex:"-1",role:"dialog","aria-labelledby":"myModalLabel","aria-hidden":"true"},a.div({"class":"modal-header"},a.button({type:"button","class":"close","data-dismiss":"modal"},"Ã—"),a.h3(e)),a.div({"class":"modal-body"},a.span(d)),a.div({"class":"modal-footer"},a.button({"class":"btn","data-dismiss":"modal","aria-hidden":"true"},"Close"),a.button({"class":"btn btn-primary",onclick:"store_pump_settings()"},"Save changes"))).appendTo(c);$("#generic-modal").modal()}var slider={};function slider_dragmove(e,c){var b=d3.event.dx;var a=slider_pos+b;slider_set_pan(a);dbd.position_viewer_from_slider(a/slider_max)}function slider_set(a){slider_set_pan(a*slider_max)}function slider_set_pan(a){if(a>slider_max){a=slider_max}else{if(a<0){a=0}}slider_pos=a;d3.select("#thumb-pan").attr("transform",fmt_translate(a,0))}function slider_path(c,h,g,b){var a=b/2;var e=g-a*2;var f="M"+(c+a)+","+h;var d=a+","+a;f+="l"+e+",0";f+="a"+d+" 0 0,1 0,"+b;f+="l-"+e+",0";f+="a"+d+" 0 0,1 0,-"+b;f+="z";return f}function thumb_path(c,h,g,b){var a=b/2;var e=g-a*2;var f="M"+c+","+(h+2);var d=a+","+a;f+="l"+e+",0";f+="a"+d+" 0 0,1 0,"+b;f+="l-"+e+",0";f+="a"+d+" 0 0,1 0,-"+b;f+="z";return f}function make_svg_gradient(a,c){var b=a.append("defs").append("linearGradient").attr("id",c).attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");b.append("stop").attr("offset","0%").attr("style","stop-color:#ccc;stop-opacity:1");b.append("stop").attr("offset","50%").attr("style","stop-color:#ddd;stop-opacity:1");b.append("stop").attr("offset","100%").attr("style","stop-color:#bbb;stop-opacity:1")}var slider_pos;var slider_max;function make_slider(d,g,f,a,h,e){make_svg_gradient(d,"slider_gradient");var i=a*e;var c=h-2*2;var n=g+2;var l=g+2+(a-h)-(i-c);slider_pos=0;slider_max=l-n;d.append("path").attr("d",slider_path(g,f,a,h)).attr("stroke","none").attr("fill","url(#slider_gradient)").on("mousedown",function(t,r){var p=d[0][0];var o=d3.mouse(p)[0];var q=3*60;if(o<slider_pos){q=-q}dbd.shift_viewer_by_minutes(q,true)});d.append("g").attr("id","thumb-pan").attr("transform","translate(0,0)").append("path").attr("id","thumb").attr("d",slider_path(n,f+2,i,c)).attr("stroke","none").attr("fill","#999").style("cursor","pointer").on("mouseover",function(p,o){d3.select(this).attr("fill","#777")}).on("mouseout",function(p,o){d3.select(this).attr("fill","#999")});var b=d3.behavior.drag().on("drag",slider_dragmove);d3.select("#thumb-pan").call(b)}if(0){var svg=d3.select("#root").append("svg").attr("width",900);make_slider(svg,50,30,500,18,1/24)}tooltip={};tooltip.init=function(){this.div=d3.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").style("color","white").text("a simple tooltip");this.locked=false};tooltip.travel=function(){var b=(d3.event.pageY-10)+"px";var a=(d3.event.pageX+10)+"px";this.div.style("top",b).style("left",a)};tooltip.enable=function(a,b){if(!this.locked){this.div.text(b);this.div.style("visibility","visible");this.item=a;this.item.attr("stroke","white");this.travel()}};tooltip.disable=function(){if(!this.locked){this.div.style("visibility","hidden");if(this.item!=undefined){this.item.attr("stroke","none");this.item=undefined}d3.selectAll(".remove-with-tooltip").remove()}};tooltip.disable_no_stroke=function(){if(!this.locked){this.div.style("visibility","hidden");this.item=undefined;d3.selectAll(".remove-with-tooltip").remove()}};tooltip.lock=function(){this.locked=true};tooltip.unlock=function(){this.locked=false};tooltip.break_lock=function(){if(this.locked){this.locked=false;this.disable()}};function bg_counts(a){var d={n_high:0,n_low:0,n_normal:0,n_marginal:0,n_really_high:0};var b;for(b in a){var c=a[b];if(c.y<80){d.n_low+=1;c.ring=0}else{if(c.y<140){d.n_normal+=1;c.ring=1}else{if(c.y<180){d.n_marginal+=1;c.ring=2}else{if(c.y<350){d.n_high+=1;c.ring=3}else{d.n_really_high+=1;c.ring=4}}}}}return d}function one_ring(c,g,e,b,f){var a;if(f==undefined){a=0}else{a=f.outer}var h=c/g*e;var d=a+h;return{inner:a,outer:d,color:b}}function build_rings(a,b){e=[];log(a);var d=ring_total(a);var e=[];var c=one_ring(a.n_low,d,b,"lightblue",undefined);e.push(c);c=one_ring(a.n_normal,d,b,"lightgreen",c);e.push(c);c=one_ring(a.n_marginal,d,b,"lightyellow",c);e.push(c);c=one_ring(a.n_high,d,b,"lightpink",c);e.push(c);c=one_ring(a.n_really_high,d,b,"#c090c0",c);e.push(c);log(e);return e}function draw_dartboard(b,i){var c=telemetry.selectBGs(b,i);var a=d3.select("#dartboard");var p=parseInt(a.style("width"));var g=Math.round(0.67*p);var l=a.append("svg").attr("width",p).attr("height",g);var n=ring_normalize(bg_counts(c));var f=Math.min(p,g)*0.9/2;var o=build_rings(n,f);var e=p/2;var d=g/2;draw_board(l,e,d,o);launch_dartboard_dots(l,o,p,g,e,d,c)}function ring_total(a){return a.n_low+a.n_normal+a.n_marginal+a.n_high+a.n_really_high}function ring_normalize(b){var a={};a.n_low=Math.sqrt(b.n_low);a.n_normal=Math.sqrt(b.n_normal);a.n_marginal=Math.sqrt(b.n_marginal);a.n_high=Math.sqrt(b.n_high);a.n_really_high=Math.sqrt(b.n_really_high);return a}function draw_board(b,a,e,d){var c=d3.svg.arc().startAngle(0).endAngle(2*Math.PI).innerRadius(function(f){return f.inner}).outerRadius(function(f){return f.outer});b.append("g").attr("transform","translate("+a+","+e+")").selectAll("path").data(d).enter().append("path").style("fill",function(f){return f.color}).style("stroke",function(f){return f.color}).attr("d",c)}function r5(){return ~~(Math.random()*5)}function random_ring(b,a,i){var e={};var d=Math.random()*2*Math.PI;var g=b.outer-b.inner;var h=10;var c;if(g<h*2){c=g/2}else{c=(g-h*2)*Math.random()+h}c+=b.inner;e.x=a+c*Math.cos(d);e.y=i+c*Math.sin(d);return e}function pick_one(b){var e=b.length;var c=~~(Math.random()*b.length);var d=b[c];b[c]=b[e-1];b.pop();return d}function launch_dartboard_dots(c,o,p,l,i,f,e){var a=[];var n=c;var b=d3.layout.force().nodes(a).links([]).gravity(0).size([p,l]);b.on("tick",function(h){var g=0.1*h.alpha;a.forEach(function(r,q){r.y+=(r.focus.y-r.y)*g;r.x+=(r.focus.x-r.x)*g});n.selectAll("circle.node").attr("cx",function(q){return q.x}).attr("cy",function(q){return q.y})});var d=0;setInterval(function(){var q=pick_one(e);var h=random_ring(o[q.ring],i,f);var g=uniform(0,p);var r=uniform(0,l);a.push({focus:h,x:g,y:r,color:bg_to_simple_color(q.y)});b.start();n.selectAll("circle.node").data(a).enter().append("svg:circle").attr("class","node").attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("r",8).style("fill",function(t){return t.color}).style("stroke",function(t){return"black"}).style("stroke-width",1.5).call(b.drag)},100)}var buckle={};buckle.icon=function(a){return $.el.span({"class":a})};buckle.well=function(){return $.el.div({"class":"well"})};buckle.vbox=function(a){return $.el.div({"class":"span"+a})};function addto(c,a,b){if(b==undefined){return}if(c[a]!=undefined){c[a]+=" "+b}else{c[a]=b}}buckle.config_clickable=function(b){var a={style:"cursor: pointer;"};addto(a,"class",b["class"]);if(b.onclick!=undefined){a.onclick=b.onclick}else{if(b.href!=undefined){a.href=b.href}}return a};buckle.expand_sidebar=function(h){var g=[];var d,e,c;var n;for(d=0;d<h.length;++d){var p=h[d];if(p.text==="-devices-"){g.push({heading:"Devices & Apps"});var f=srclist.getall();for(e=0;e<f.length;e++){var q=f[e];var i=source_type[q.type];var a=q.ui_desc;n={text:a,href:"#",subitems:[]};for(c=0;c<i.operations.length;c++){var b=i.operations[c];n.subitems.push({text:b.text,onclick:b.action+'("'+q.id+'")'})}g.push(n)}if(f.length!==0){g.push({text:"-divider-"})}}else{g.push(p)}}return g};buckle.radio_items=function(o,h){var f;var l=$.el;var c,d;for(c=0;c<h.length;++c){var q=h[c];f={};if(q.id!=undefined){f.id=q.id}var a;if(q.heading!=undefined){f["class"]="nav-header";a=l.li(f,q.heading)}else{if(q.text=="-divider-"){f["class"]="divider";a=l.li(f)}else{var g=this.config_clickable(q);var i;if(q.text){i=q.text.replace(/\s+/g,"")}else{i="n.a."}g["data-target"]="#demo"+i;if(q.subitems){a=l.li(f,l.a(g,q.text,l.i({"class":"icon-chevron-right"})));var e=l.ul({id:"demo"+i,"class":"submenuradio collapse nav nav-list",style:"height: 0px;"});for(d=0;d<q.subitems.length;d++){var n=q.subitems[d];g=this.config_clickable(n);var p=l.li(l.a(g,n.text));p.appendTo(e)}e.appendTo(a)}else{a=l.li(f,l.a(g,q.text))}}}a.appendTo(o)}};buckle.tab_menu=function(a){var b=$.el.ul({"class":"nav nav-tabs menuradio"});this.radio_items(b,a);return b};buckle.radio_buttons=function(b){var a=$el.div({"class":"btn-group","data-toggle":"buttons-radio"});this.button_items(a,b);return a};var user_button;var user_button_container;var group_button;var group_button_container;function attach_user_button(a){user_button.appendTo(user_button_container);d3.select("#user_name").text(" "+a+" ")}function attach_group_button(c){if(c.length<=0){return}group_button.appendTo(group_button_container);d3.select("#fb_group_name").text(" "+c[0].name+" ");var f=$("#fb_group_menu").get(0);var a=$.el;var d;for(d=0;d<c.length;++d){var e=c[d].name;a.li(a.a({style:"cursor: pointer;",onclick:'set_fb_group("'+e+'")'},e)).appendTo(f)}a.li({"class":"divider"}).appendTo(f);a.li(a.a({style:"cursor: pointer;",onclick:'set_fb_group("sb_build_unimp()")'},"Add Group")).appendTo(f)}buckle.navbar=function(h,i,d,c,g){var n=$.el;var l=n.ul({"class":"dropdown-menu"});this.radio_items(l,c);user_button=n.span({"class":"btn-group"},n.a({"class":"btn dropdown-toggle","data-toggle":"dropdown",href:"#"},n.i({"class":"icon-user"}),n.span({id:"user_name"}," "+i+" "),n.span({"class":"caret"})),l);user_button_container=n.span();var f=n.ul({"class":"dropdown-menu",id:"fb_group_menu"});group_button=n.span({"class":"btn-group"},n.a({"class":"btn dropdown-toggle","data-toggle":"dropdown",href:"#"},n.i({"class":"icon-book"}),n.span({id:"fb_group_name"}," none "),n.span({"class":"caret"})),f);group_button_container=n.span();var e=n.ul({"class":"nav menuradio"});this.radio_items(e,g);var a=n.div({"class":"nav-collapse"},e);return n.div({"class":"navbar navbar-fixed-top"},n.div({"class":"navbar-inner"},n.div({"class":"container-fluid"},n.a({"class":"btn btn-navbar","data-toggle":"collapse","data-target":".nav-collapse"},n.span({"class":"icon-bar"}),n.span({"class":"icon-bar"}),n.span({"class":"icon-bar"})),n.a({"class":"brand"},h),n.span({"class":"pull-right"},group_button_container,n.span({style:"margin:3px"}),user_button_container),a)))};buckle.sidebar=function(a){var b=$.el.ul({"class":"nav nav-list menuradio"});this.radio_items(b,a);var c=$.el.div({"class":"well sidebar-nav"});b.appendTo(c);return c};var fb={};fb.enabled=true;fb.loaded=false;fb.logged_in=false;fb.boot=function(){$.ajax({type:"GET",url:"/api/"+api_v_str+"/fb-info",dataType:"json",success:function(a,b){fb.init(a.appId,a.channelUrl)},error:function(a){log("fb.boot failed");fb.enabled=false;run_without_facebook()},data:{},async:true})};fb.init=function(b,a){window.fbAsyncInit=function(){log("FB.init");FB.init({appId:b,channelUrl:a,status:true,cookie:true,xfbml:true});fb.loaded=true;spa_build_login_page(false);FB.Event.subscribe("auth.statusChange",function(c){log("auth.statusChange");log(c);fb.status_change(c)})};(function(f){var e,g="facebook-jssdk",c=f.getElementsByTagName("script")[0];if(f.getElementById(g)){return}e=f.createElement("script");e.id=g;e.async=true;e.src="//connect.facebook.net/en_US/all.js";c.parentNode.insertBefore(e,c)}(document))};fb.postmessage=function(a,c,d){var b={};b.message=c;FB.api("/"+a+"/feed","post",b,function(e){if(!e||e.error){generic_modal("Error Posting to Facebook",e.error.message)}else{if(d){d()}}})};fb.postcomment=function(a,c,d){var b={};b.message=c;FB.api("/"+a+"/comments","post",b,function(e){if(!e||e.error){generic_modal("Error Posting to Facebook",e.error.message)}else{if(d){d()}}})};fb.select_group=function(b){var a;for(a in fb.groups){var c=fb.groups[a];if(c.name==b){this.selected_group=a;return}}log("no such group: "+b)};fb.get_selected_group=function(){if(this.selected_group==undefined){return undefined}return this.groups[this.selected_group]};fb.set_default_group=function(){this.selected_group=0;if(this.groups!=undefined&&this.groups.length>0){if(this.groups[this.selected_group].name=="g.JaneSmith"&&this.groups.length>1){this.selected_group=1}for(k in this.groups){var a=this.groups[k];if(a.name=="g.ElectraWhite"){this.selected_group=k;return}}}};fb.lookup_group=function(a){if(fb.groups==undefined){return undefined}for(k in fb.groups){var b=fb.groups[k];if(b.name==a){return b}}};fb.lookup_gdot_groups=function(){if(fb.groups==undefined){return undefined}var a=[];for(k in fb.groups){var b=fb.groups[k];var c=b.name.split(".");if(c[0]=="g"){a.push(b)}}return a};fb.finish_login=function(){log("FINISH-LOGIN");if(fb.me!=undefined&&fb.groups!=undefined){log("FINISH-LOGIN-CB");attach_user_button(fb.me.username);fb.groups=fb.lookup_gdot_groups();if(fb.groups.length>0){fb.set_default_group();attach_group_button(fb.groups);var a=this.get_selected_group();set_fb_group(a.name)}else{log("no blip groups found in facebook")}}};fb.waiting_for_feed=false;fb.get_feed=function(c,d){var a=c.id;var b="/"+a+"/feed";fb.waiting_for_feed=true;FB.api(b,function(e){fb.waiting_for_feed=false;console.log("GET GROUP FEED");console.log(e);if(d){d(e)}})};fb.status_change=function(a){log("RESPONSE");log(a);if(a.status==="connected"){fb.logged_in=true;fb.access_token=a.authResponse.accessToken;log("ACCESS TOKEN");log(fb.access_token)}else{if(a.status==="not_authorized"){fb.logged_in=false;spa_build_login_page(true);return}else{fb.logged_in=false;spa_build_login_page(false);return}}FB.api("/me",function(b){console.log("Good to see you, "+b.name+".");console.log(b);fb.me=b;fb.finish_login()});FB.api("/me/groups",function(c){var b;fb.groups=c.data;for(b in fb.groups){var d=fb.groups[b];log(d.name+" = "+d.id)}console.log("GROUPS");console.log(c);fb.finish_login()})};var api_v_major=0;var api_v_minor=1;var api_v_str=api_v_major+"."+api_v_minor;var pump_files=["pump-bg","pump-cbg","pump-insulin","pump-events","pump-settings","pump-adherence"];var omh_files=["omh-activity","omh-food","omh-glucose","omh-mood","omh-notes","omh-runkeeper-activity","omh-weight"];var daterange={};var active_timers=[];function check_ready(){if(fb.waiting_for_feed){return}else{if(telemetry.loaded){view_set_date(add_days(midnight(telemetry.maxDate),1));sb_build_dashboard()}else{sb_build_intro()}}}function build_food_message(b){var a="";if(b.carbCount!=undefined){a+=b.carbCount+"g of carbs."}if(b.carbNote!=undefined){a+=" "+b.carbNote}if(b.proteinCount!=undefined){a+=" "+b.proteinCount+"g of protein."}if(b.proteinNote!=undefined){a+=" "+b.proteinNote}return a}function build_note_message(a){return a.note}function make_message(a,d){var c={};var b=d.y;c.from={name:"Alex Freeman",id:"167104993434955"};if(typeof b=="string"){c.message=b}else{if(b.carbCount!=undefined){c.message=build_food_message(b)}else{if(b.note!=undefined){c.message=build_note_message(b)}else{log("BUG");log(b);c.message="TELL STEVE THIS IS A BUG"}}}c.message=a+c.message;c.created_time=d.x+"";return c}function convert_notes_to_feed(d){var b,c,g,a,f;var e={data:[],omh:true};for(b=0;b<d.length;++b){f=d[b];a=f.y;g=make_message("[OMH] ",a[0]);g.comments={data:[]};for(c=1;c<a.length;++c){g.comments.data.push(make_message("",a[c]))}e.data.push(g)}return e}var dashboard_feed;function feed_ready(a){dashboard_feed=a;check_ready()}function draw_dashboard(u,e){dashboard_clear();var d=telemetry.selectBGs(u,e);var x=telemetry.selectCgm(u,e);var b=telemetry.selectCarbs(u,e);var q=telemetry.selectBolus(u,e);var y=telemetry.selectBasal(u,e);var c=telemetry.selectEvents(u,e);var f=telemetry.basal_bolus_mix(u,e);var p=telemetry.selectActivity(u,e);var t=telemetry.selectRk(u,e);var i=telemetry.selectOMHNotes(u,e);var a=convert_notes_to_feed(i);var n=d3.select("#dashboard");var g=parseInt(n.style("width"));var r=Math.round(0.67*g);dbd.init(n,u,e,g,r);dbd.data(d,x,b,q,y,c,f,p,t,a);var l=dbd.mode;dbd.mode="none";dbd.set_mode(l);var o="#"+l+"_tab";log(o);d3.select(o).attr("class","active");refresh_date_selector(daterange.sdate,daterange.edate)}function dashboard_clear(){d3.select("#dashboard").selectAll("svg").remove()}function dashboard_resize(){draw_dashboard(daterange.sdate,daterange.edate)}var resize_callback=undefined;function check_for_resize(){dashboard_clear();if(resize_callback!=undefined){clearTimeout(resize_callback)}resize_callback=setTimeout(function(){dashboard_resize()},500)}d3.select(window).on("resize",function(){check_for_resize()});function set_daily(){dbd.set_mode("daily")}function set_hourly(){dbd.set_mode("hourly")}function set_detail(){dbd.set_mode("detailed")}function set_stacked(){dbd.set_mode("stacked")}function set_day_by_day_cgm(){dbd.plot("day",ts_cgm)}function set_hourly_cgm(){dbd.plot("bg",ts_cgm)}var sidebar_items=[{heading:"Views"},{text:"Sugar Plot",onclick:"sb_build_dashboard()",id:"sugarbook_tag"},{text:"Sugar Trend",onclick:"sb_build_sugar_trend()"},{text:"Dartboard",onclick:"sb_build_dartboard()"},{text:"-divider-"},{heading:"Messages"},{text:"Updates",onclick:"sb_build_updates()"},{text:"Alerts",onclick:"sb_build_unimp()"},{text:"-divider-"},{text:"-devices-"}];var spa_items=[{text:"Home",onclick:"spa_build_home()",radio:"spa",id:"home_tag"},{text:"News",onclick:"spa_build_news()",radio:"spa"},{text:"About Us",onclick:"spa_build_about()",radio:"spa"},{text:"Help",onclick:"spa_build_unimp()",radio:"spa"},{text:"Contact Us",onclick:"spa_build_contact_us()",radio:"spa"}];var user_items=[{text:"Profile",onclick:"spa_build_unimp()"},{text:"-divider-"},{text:"Signout",onclick:"spa_build_unimp()"}];function spa_init(){var c=$("#root").get(0);var a=$.el;var d=buckle.navbar("blip","user",0,user_items,spa_items);d.appendTo(c);$.el.div({id:"spa_root"}).appendTo(c);spa_reset()}function spa_reset(){d3.select("#spa_page").remove();var b=$("#spa_root").get(0);var a=$.el.div({"class":"spa-frame",id:"spa_page"});a.appendTo(b);return a}function unimp(e){var c="<h1>Under construction...!</h1>";var a=$.el;var d=a.div({"class":"hero-unit"});d.innerHTML=c;a.div(d,a.p("This view under contruction..."));d.appendTo(e)}function nodev(c){var a=$.el;a.div(a.p("under contruction...")).appendTo(c)}function spa_build_unimp(){var a=spa_reset();unimp(a)}function spa_build_contact_us(){var c="<h2>Contact us...</h2>";c+="<p><p>";c+="Contact us at <i>info</i> 'at' <i>sugardotz.org</i>";var e=spa_reset();var a=$.el;var d=a.div({"class":"hero-unit"});d.innerHTML=c;a.div(d).appendTo(e)}function spa_build_about(){var c="<h2>About blip...</h2>";c+="<p><p>";c+="blip is a non-profit corporation developing innovative software solutions based on an open, cloud-based data architecture in which different vendors in the diabetes ecosystem can interoperate through open APIs to a create an improved, consumer-mediated model for managing diabetes data with the goal of simplifying patients lives, improving health care delivery, and creating better health outcomes. <a href='http://www.sugardotz.org'>SugarDotz</a> is the first application under development by the blip organization.";c+="<h3>Our Team</h3><p><p>";c+='<a href="http://diabetes.ucsf.edu/members/adi-saleh">Saleh Adi, MD</a><br>Pediatric Endocrinologist<br>Director, Madison Clinic for Pediatric Diabetes at UCSF<br><p><a href="http://neonatology.ucsf.edu/our-team/bios/suny.aspx">Yao Sun, MD, PhD</a><br>Neonatologist<br>Medical Director, Intensive Care Nursery, UCSF Benioff Childrenâ€™s Hospital<br>Associate Professor of Clinical Pediatrics, UCSF<br><p><a href="http://www.linkedin.com/pub/jenise-wong/4b/525/ba7">Jenise Wong, MD, PhD</a><br>Pediatric Endocrinologist<br>Clinical Instructor, UCSF<br><p><a href="http://www.aneinstein.com/">Aaron Neinstein, MD</a><br>Clinical Fellow, Endocrinology, UCSF<br>';var a=spa_reset();a.div().div("class=hero-unit").html(c).pop().pop()}function spa_build_login_page(f){var c="<h2>Welcome to blip!</h2>";c+="<p><p>";c+="<b>blip</b> is your on-line place for understanding and tracking your blood sugar, insulin, carb intake, and physical activity.  Diabetes sucks, but it doesn't have to be hard.  <b>blip</b> will make dealing with diabetes easier for you.  And it can even be fun!";c+='<div align="right"><div class="fb-login-button" scope="user_groups,publish_stream">Login with Facebook</div></div>';if(f){c+="<p><p>";c+="Note you are logged in to facebook but have not authorized <b>blip</b> to access you facebook information. If you want to use <b>blip</b>, you need to grant the <b>blip</b> site this access."}var e=spa_reset();var a=$.el;var d=a.div({"class":"hero-unit"});d.innerHTML=c;d.appendTo(e);FB.XFBML.parse()}function spa_build_no_group(d){var c="<h2>No <b>blip</b> facebook groups...</h2>";c+="<p><p>";c+="We can't find any <b>blip</b> groups in your facebook.  You have successfully logged into <b>blip</b> with your facebook account.  However, it appears you are not a member of any facebook groups that are registered with <b>blip</b>. In order to use <b>blip</b>, you need to be a member of such a group.  Please join a group, then come back and log in again...";var a=spa_reset();a.div().div("class=hero-unit").html(c).pop().pop()}function spa_build_news(){var c='<iframe width=95% height=90% src="http://greendotdiabetes.org/"></iframe>';var a=spa_reset();a.div().style("margin-left","10px").html(c).pop()}function sb_build_unimp(){var a=sb_reset();unimp(a)}function sb_build_intro(){var c="<h2>Hello "+fb.me.first_name+"</h2>";c+="<p><p>";c+="it looks like no one has added any device or app for this patient         yet. You can add one by clicking on <b>Add</b> under <b>DEVICES & APPS</b>         in the menu bar on the left.";var e=sb_reset();var a=$.el;var d=a.div({"class":"hero-unit"});d.innerHTML=c;a.div(d,a.p("This view under contruction..."));d.appendTo(e)}function sb_build_nodev(){var a=sb_reset();nodev(a)}function select_green_dots(){dbd.set_mode("simple")}function select_detail_dots(){dbd.set_mode("detailed")}function spa_build_home(i,e,d){if(fb.enabled&&!fb.logged_in){spa_build_login_page(false);return}if(fb.enabled){log("DEFAULT GROUP");var h=fb.get_selected_group();if(h==undefined){spa_build_no_group();return}}var f=spa_reset();var a=$.el;if(i&&e){if(!d){d="alert alert-success"}a.div({"class":d},a.button({type:"button","class":"close","data-dismiss":"alert"},"Ã—"),a.h4(e),i).appendTo(f)}var c=buckle.expand_sidebar(sidebar_items);var g=buckle.sidebar(c);a.div({"class":"sidebar-frame"},g).appendTo(f);a.div({"class":"sidebar-page",id:"sb-root"}).appendTo(f);if(!(fb.waiting_for_feed||!telemetry.loaded)){sb_build_dashboard()}d3.select("#home_tag").attr("class","active");activate_radio_buttons()}function prefixify(e,d,g,f){var a;for(a=0;a<d.length;++a){var c=e+"/"+d[a];if(f){var b=fb.access_token;if(b!==undefined){c+="?access_token="+b}}g.push(c)}return g}function create_rest_body(){var b={};var a=fb.access_token;if(a!==undefined){b.access_token=a}return b}function set_fb_group(b,f,l,e){var c;var i;var g=[];var a;var d;daterange={};log("set_fb_group "+b);d3.select("title").text(b);d3.select("#fb_group_name").text(" "+b+" ");fb.select_group(b);var h=fb.get_selected_group();fb.get_feed(h,feed_ready);a=srclist.getall();for(c=0;c<a.length;c++){d="/api/"+api_v_str+"/groups/"+h.id+"/sources/"+a[c].id;g=prefixify(d,source_type[a[c].type].data_files,g,true)}telemetry.load(g,check_ready);spa_build_home(f,l,e)}function sb_build_updates(){var a=fb.get_selected_group();fb.get_feed(a,sb_build_updates_callback)}function modal_comment_key_handler(e){var f=e.target;if(f.clientHeight<f.scrollHeight){$(f).get(0).rows++}if(e.keyCode==13){if(e.shiftKey){$(f).get(0).rows++}else{var c=$.el;var i=f.id.substring(3);var a=$("#modal-comment-"+i);a.remove();var h=$("#md-"+i).get(0);var d=new Date();var g=c.div({"class":"modal-comment"},c.a({href:"#",target:"_blank"},c.b(fb.me.first_name+" "+fb.me.last_name)),c.br(),c.i(format_time(d)+" "+friendly_date2(d)),c.p(f.value)).appendTo(h);c.div({"class":"modal-comment",id:"modal-comment-"+i},c.textarea({"class":"commentbox",style:"width:95%",id:"nc-"+i,type:"text",placeholder:"Write comment...",rows:"1",onkeydown:"modal_comment_key_handler(event)"})).appendTo(h);fb.postcomment(i,f.value,function(){return});return false}}}function comment_key_handler(a){var c=a.target;if(c.clientHeight<c.scrollHeight){$(c).get(0).rows++}if(a.keyCode==13){if(a.shiftKey){$(c).get(0).rows++}else{var b=fb.get_selected_group();var d=c.id.substring(3);fb.postcomment(d,c.value,sb_build_updates);return false}}}function sb_build_updates_callback(c){if(c){dashboard_feed=c}var f=sb_reset();var a=$.el;var g=a.div({"class":"row-fluid"});var e=a.div({"class":"span10"},g);if(dashboard_feed!=undefined){var d=build_updates_html(g,dashboard_feed)}e.appendTo(f);$(".commentbox").keydown(comment_key_handler)}function update_goto(a){$("#sugarbook_tag a").click();var b=new Date();b.setTime(a);dbd.click_to_detailed(b)}function fb_post_click(){var a=fb.get_selected_group();fb.postmessage(a.id,$("#fb-newpost").get(0).value,sb_build_updates)}function one_update(n,d,g){var i=$.el;var l=d.from.name;var a="http://www.facebook.com/"+d.from.id;var e=new Date(d.created_time.replace("+0000","+00:00"));var o=d.message;if(o===undefined){o=""}var c=e.getTime();var f=i.div({"class":g},i.a({href:a,target:"_blank"},i.b(l)),i.br(),i.i(format_time(e)+" "+friendly_date2(e)),i.a({href:"#",onclick:"update_goto("+c+"); return false;"},i.b(" [Sugar Detail]")),i.p(o));if(d.type=="photo"&&g!="comment"){var h=i.a({href:d.link,target:"_blank"},i.img({src:d.picture})).appendTo(f);i.br().appendTo(f);i.br().appendTo(f)}if(n){f.appendTo(n);return f}else{return f.innerHTML}}function build_updates_html(l,g){var f=$.el;var c=f.div(f.div({"class":"well",style:"width:70%"},f.textarea({style:"width:100%",id:"fb-newpost",type:"text",placeholder:"Write new post...",rows:"1",onfocus:'$("#fb-newpost").get(0).rows = 3;'}),f.div({style:"text-align:right;width:100%;"},f.div({"class":"btn btn-info",style:"text-align:right",id:"fb-post-button",href:"#",onclick:"fb_post_click();"}," Post"))),f.p(),f.p());var i=g.data;for(k in i){var h=i[k];f.hr().appendTo(c);var d=one_update(c,h,"post");if(h.comments!=undefined){var e=h.comments.data;for(v in e){var a=e[v];one_update(d,a,"comment")}}f.div({"class":"comment"},f.textarea({"class":"commentbox",style:"width:95%",id:"nc-"+h.id,type:"text",placeholder:"Write comment...",rows:"1"})).appendTo(d);f.div({"class":"frame-clear"}).appendTo(c)}c.appendTo(l)}function reset_periodic_callbacks(){var a;for(a=0;a<active_timers.length;a++){clearInterval(active_timers[a])}active_timers=[];hide_spinner()}function handle_radio_button_click(d,a){var f=$(d).children("a[data-target]").data("target");if($(d).children("ul").length!==0){$(f).collapse("toggle");var c=$(d).children("a").children("i");if($(f).hasClass("in")){c.attr("class","icon-chevron-down")}else{c.attr("class","icon-chevron-right")}}else{var b=$(d);var e=a.find(".active");e.removeClass("active");b.addClass("active")}}function activate_radio_buttons(){$(".menuradio > li > a[data-target]").parent("li").click(function(a){if($(a.target).parent().get(0)!=this){return}handle_radio_button_click(this,$(this).parent())});$(".menuradio > li > a[data-target] > i").click(function(a){handle_radio_button_click($(this).parents("li").get(0),null)});$(".submenuradio > li").click(function(a){handle_radio_button_click(this,$(this).parent().parent().parent())})}function sb_reset(){reset_periodic_callbacks();d3.select("#sb-page").remove();var a=$("#sb-root").get(0);var b=$.el.div({id:"sb-page"});b.appendTo(a);return b}function sb_build_summary(){var a=sb_reset();a.well().id("d3-summary").pop();draw_summary()}function sb_build_sugar_trend(){var c=sb_reset();var a=$.el;$.el.div({"class":"well",id:"sugar-trend"}).appendTo(c);draw_sugar_trend()}function sb_build_insulin_trend(){var c=sb_reset();var a=$.el;a.div({"class":"well"},a.div({"class":"col1"},a.div({"class":"page-header"},a.h2("insulin trend")),a.br(),a.span("Interval: "),a.div({"class":"=btn-group"},a.a({"class":"btn dropdown-toggle","data-toggle":"dropdown",href:"#"}," interval ",a.span({"class":"caret"})))),a.div({id:"insulin-trend"})).appendTo(c);draw_insulin_trend()}function sb_build_pump(){var c=sb_reset();var a=$.el;$.el.div({"class":"well",id:"pump-page"}).appendTo(c);draw_pump()}function sb_build_dartboard(){var c=sb_reset();var a=$.el;a.div({"class":"well",id:"dartboard"}).appendTo(c);draw_dartboard(daterange.sdate,daterange.edate)}function sb_build_sync_single(a){create_sync_page(a)}function sb_build_sync_all(){create_sync_page("")}function sb_build_add_device(){create_add_device_page()}function fb_group_list(){var a=$.el;var c;var e=a.ul();for(c in fb.groups){var f=fb.groups[c];var d="";d+="https://graph.facebook.com/"+f.id;d+="?access_token="+fb.access_token;a.li(a.a({href:d},f.name)).appendTo(e)}return e}function sb_build_groups(){var d=sb_reset();var c=fb_group_list();var a=$.el;a.div({"class":"well"},a.div({"class":"col1"},a.div({"class":"page-header"},a.h2("Facebook Groups")),a.p("These are the groups we found via the Facebook API..."),c)).appendTo(d)}function refresh_date_selector(a,b){d3.select("#date-button").text(friendly_date3(b));if(false){var c="<i>Displaying two weeks from ";c+=friendly_date2(a);c+=" to ";c+=friendly_date2(b);c+="</i>"}d3.select("#date-desc").html(c)}function view_set_date(b){if(b.getTime()!=midnight(b).getTime()){log("! bad edate in view_set_date")}var a=add_days(b,-13);var c=add_days(midnight(telemetry.maxDate),1);if(b.getTime()>c.getTime()){b=c;a=add_days(b,-13)}daterange.sdate=a;daterange.edate=b;refresh_date_selector(a,b)}function date_right(){view_set_date(add_days(daterange.edate,7));draw_dashboard(daterange.sdate,daterange.edate)}function date_left(){view_set_date(add_days(daterange.edate,-7));draw_dashboard(daterange.sdate,daterange.edate)}function click_numbers(){dbd.set_numbers_disposition()}function click_entra(){log("click_entra: "+$("#checkbox_show_entra").prop("checked"));dbd.set_entra_disposition()}function sb_build_dashboard(){var a=sb_reset();sb_really_build_dashboard(a)}function sb_really_build_dashboard(d){var a=$.el;var c=a.label({"class":"checkbox inline left-pad"});c.innerHTML='<input type="checkbox" value="x" id="checkbox_show_numbers" onchange=click_numbers()>Show Numbers</input>';var e=a.div({"class":"well"},a.div({"class":"col1"},a.div({"class":"btn-group"},a.a({"class":"btn",onclick:"date_left()"},buckle.icon("icon-chevron-left")),a.a({"class":"btn",href:"#",id:"date-button"},"mm/dd/yyyy"),a.a({"class":"btn",onclick:"date_right()"},buckle.icon("icon-chevron-right"))),c,a.a({"class":"btn pull-right",onclick:"sb_build_fullscreen()"},buckle.icon("icon-resize-full"))),a.br(),buckle.tab_menu([{text:"Day",id:"daily_tab",onclick:"set_daily()"},{text:"Hour",id:"hourly_tab",onclick:"set_hourly()"},{text:"Detailed",id:"detailed_tab",onclick:"set_detail()"}]),a.div({id:"dashboard"})).appendTo(d);$("#checkbox_show_numbers").prop("checked",dbd.show_numbers);draw_dashboard(daterange.sdate,daterange.edate);d3.select("#sugarbook_tag").attr("class","active");activate_radio_buttons()}function go_full_screen(a){if(a.requestFullScreen){a.requestFullScreen()}else{if(a.mozRequestFullScreen){a.mozRequestFullScreen()}else{if(a.webkitRequestFullScreen){a.webkitRequestFullScreen()}}}}function sb_build_fullscreen(){var b=sb_reset();var a=document.getElementById("sb-page");go_full_screen(a);sb_really_build_dashboard(b)}function init_edate_datepicker(){var a=$("#db-edate");a.datepicker({format:"m/d/yyyy"});a.datepicker().on("changeDate",function(d){var c=new Date(d.date);var b=midnight(add_days(c,-13));if(c.valueOf()>midnight(telemetry.maxDate)){c=midnight(telemetry.maxDate);b=add_days(c,-13)}if(b.valueOf()<midnight(telemetry.minDate)){b=telemetry.minDate;c=add_days(c,13)}a.attr("value",c);a.text(friendly_date3(c));a.datepicker("hide");a.attr("class","inactive");a.blur();dashboard_clear();draw_dashboard(b,c)})}function run_without_facebook(){var b="/api/"+api_v_str+"/groups/359767674103279";var a=prefixify(b,pump_files,[],true);if(true){b="/api/"+api_v_str+"/groups/167104993434955";a=prefixify(b,pump_files,[],true);a=prefixify(b,omh_files,a,true)}telemetry.load(a,check_ready);spa_build_home()}function main(){tooltip.init();spa_init();fb.boot()}$(document).ready(main);